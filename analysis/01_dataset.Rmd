---
title: "01_dataset_creation"
output: html_document
---

# Environment

```{r}
library(data.table)
library(summarytools)
library(zoo)
library(dplyr)
library(magrittr)
library(lubridate)
library(dtplyr)
library(vroom)
library(stringi)
library(tidyr)
library(parallel)
library(janitor)
library(purrr)

# defining functions

special_date = function(number){
  date = if_else(number%in%c(-1,0,NA), as.Date(NA), as.Date(as.character(number),format="%Y%m%d"))
  return(date)
}

convertir_valores <- function(x) {ifelse(x == -1, 0, 1)}
```


# Data Load

## poblacion_diana

Se filtra el sexo en dos posibles categorías: hombre y mujer. Otros eran menor al 0.1%.

```{r}
poblacion_diana <- fread("/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_POB_DIANA.txt", 
                         header = T, 
                         encoding = 'Latin-1')

poblacion_diana$COD_FEC_NACIMIENTO <- as.Date(as.character(poblacion_diana$COD_FEC_NACIMIENTO), format = "%Y%m%d") 

# changing reference in sex
poblacion_diana$DESC_SEXO <- relevel(as.factor(poblacion_diana$DESC_SEXO), ref = "Mujer" )

# age at 2020-03-01 field
poblacion_diana$age<-trunc((poblacion_diana$COD_FEC_NACIMIENTO %--% '2020-03-01' ) / years(1))

# mortality field
poblacion_diana$mortality <- convertir_valores(poblacion_diana$FEC_FALLECIMIENTO)
```
## pupa

Periodo-Usuario-PAtologías

```{r}
pupa <- fread("/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_PUPA.txt",header = T,encoding = 'Latin-1');pupa<-as.data.frame(pupa);

# Remove duplicates
pupa %<>% distinct()

# dates need to be converted from the original source, missing means NO
pupa$COD_FEC_INI_PATOLOGIA <- as.Date(as.character(pupa$COD_FEC_INI_PATOLOGIA), format="%Y%m%d")

# First, we convert the categorical variables to one without capital letters and accents
pupa$DESC_PATOLOGIA_CRONICA <- tolower(make.names(stri_trans_general(pupa$DESC_PATOLOGIA_CRONICA, "latin-ascii")))

#TODO, FILTER by admission or infection date?

# Convert the data frame to a data.table since dplyr is not efficient enough
pupa_dt <- setDT(pupa)

# Group by and mutate in a single step
pupa_opt <- pupa_dt[, value := 1, by = c("NUHSA_ENCRIPTADO", "DESC_PATOLOGIA_CRONICA")]

# Spread in a single step
#This will create a new column for each unique element in the DESC_PATOLOGIA_CRONICA column, and fill the cells with a value of 1 for rows where the DESC_PATOLOGIA_CRONICA value matches the column name, and 0 for all other rows.
pupa_opt <- dcast(pupa_opt, NUHSA_ENCRIPTADO ~ DESC_PATOLOGIA_CRONICA, value.var = "value", fill = 0)

# Replace the values in the original data frame with 1 if any value in the row is greater than 0, and 0 otherwise

# Select the first column
pupa_id <- pupa_opt[, 1]

# Select the columns starting from the second column
pupa_selected <- pupa_opt[, 2:ncol(pupa_opt)]

# Replace the values in the selected columns with 1 if they are greater than 0, and 0 otherwise
pupa_selected <- apply(pupa_selected, 2, function(x) ifelse(x > 0, 1, 0))

# Append the transformed columns to the first column
pupa_opt <- cbind(pupa_id, pupa_selected)

remove(pupa_id)
remove(pupa_selected)
remove(pupa)
remove(pupa_dt)
```

## periodos pandemicos

Información extraída del "Informe COVID-19 en Andalucía durante la fase aguda de la pandemia", elaborado por el Servicio de Estadísticas Sanitarias. Consejería de Salud y Familias. Disponible en el siguiente [enlace (exige red corporativa)](https://www.ieca.junta-andalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/50147?CodOper=b3_2314&codConsulta=50147).

```{r}
periodos_pandemicos_andalucia <- 
  read.csv2("/opt/datos_compartidos/vacunas_data/05_Periodos_pandemicos.csv") %>% 
  mutate(nombre_periodo = factor(nombre_periodo, ordered = TRUE),
         fecha_inicio = as.Date(fecha_inicio), fecha_fin = as.Date(fecha_fin))
```

## resultados_pruebas_COVID

```{r RESULTADOS_PRUEBAS_COVID}
# '_t' means total population, second data load
# database importation and tidying
resultados_pruebas_COVID <-
  fread("/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_TEST_COVID.txt",
        header = T,
        encoding = 'UTF-8') %>% 
  as.data.frame() %>% 
  select(-TIPO_PRUEBA) %>% 
  mutate(FECHA_MUESTRA = as.Date(as.character(FECHA_MUESTRA),
                                 format = "%d/%m/%Y"))
# infection count per person
infect_COVID_num <-
  resultados_pruebas_COVID %>%
  group_by(NUHSA_ENCRIPTADO) %>%
  summarise(infecc_covid_num = n())

# first COVID infection with date available
# TODO: pendientes de PRDA
infect_COVID_first <-
  resultados_pruebas_COVID %>%
  group_by(NUHSA_ENCRIPTADO) %>%
  filter(row_number() == 1 & DESC_T_PRUEBA == 'PCR' & !is.na(FECHA_MUESTRA)) %>% 
  rename(infect_COVID_first_date = FECHA_MUESTRA) %>%
  select(NUHSA_ENCRIPTADO, infect_COVID_first_date)

remove(resultados_pruebas_COVID)
```

## episodios_cmbd

Episodios CMBD del 03/03/2019 al 01/04/2022.

One of the first 5 admission diagnoses, should be in this list

var1	freq	descripcion
U07.1	41192	COVID-19
J18.9	11869	Neumonía, microorganismo no especificado
J12.89	3384	Otros tipos de neumonía vírica
J22	3046	Infección aguda del tracto respiratorio inferior, no especificada
J96.00	2305	Insuficiencia respiratoria aguda no especificada si con hipoxia o con hipercapnia
J96.01	2131	Insuficiencia respiratoria aguda con hipoxia
J96.02	1317	Insuficiencia respiratoria aguda con hipercapnia
J96.20	1177	Insuficiencia respiratoria aguda y crónica no especificada si con hipoxia o con hipercapnia
J90	1113	Derrame pleural, no clasificable bajo otro concepto
J47.0	1045	Bronquiectasias con infección aguda de vías respiratorias bajas
J96.21	772	Insuficiencia respiratoria aguda y crónica con hipoxia
J98.01	597	Broncoespasmo agudo
J18.0	512	Bronconeumonía, microorganismo no especificado
J84.9	497	Enfermedad intersticial pulmonar, no especificada
J96.91	365	Insuficiencia respiratoria no especificada, con hipoxia
J96.90	348	Insuficiencia respiratoria no especificada, sin especificar si con hipoxia o con hipercapnia
J96.92	339	Insuficiencia respiratoria no especificada, con hipercapnia
J84.89	330	Otros tipos de enfermedades pulmonares intersticiales especificadas
J81.0	302	Edema agudo de pulmón
I26.99	291	Otra embolia pulmonar sin cor pulmonale agudo
J06.9	204	Infección respiratoria aguda del tracto respiratorio superior, no especificada
J98.9	112	Trastorno respiratorio, no especificado
J95.89	107	Otras complicaciones y trastornos posprocedimiento de aparato respiratorio, no clasificados bajo otro concepto
J12.9	86	Neumonía vírica, no especificada
O98.52	82	Otras enfermedades virales que complican el parto
J84.111	72	Neumonía intersticial idiopática, no especificada de otro modo
O98.513	70	Otras enfermedades virales que complican el embarazo, tercer trimestre
J20.8	66	Bronquitis aguda por otros organismos especificados
J96.11	64	Insuficiencia respiratoria crónica con hipoxia
J00	62	Nasofaringitis aguda [resfriado común]
J12.81	42	Neumonía por coronavirus asociado al SARS
J84.114	42	Neumonitis intersticial aguda
J39.8	41	Otras enfermedades especificadas del tracto respiratorio superior
J84.115	15	Enfermedad pulmonar intersticial asociada a bronquiolitis respiratoria

TODO hay 92k pacientes sin fecha de ingreso. rafa: a mi ma salen todos con Fecha ingreso y alta.
TODO puede ser que ya estuvieran ingresados.

```{r}
icd_ofinterest <- c('U07.1', 'J18.9', 'J12.89', 'J22', 'J96.00', 'J96.01', 'J96.02', 'J96.20', 'J90', 'J47.0', 'J96.21', 'J98.01', 'J18.0', 'J84.9', 'J96.91', 'J96.90', 'J96.92', 'J84.89', 'J81.0', 'I26.99', 'J06.9', 'J98.9', 'J95.89', 'J12.9', 'O98.52', 'J84.111', 'O98.513', 'J20.8', 'J96.11', 'J00', 'J12.81', 'J84.114', 'J39.8', 'J84.115', 'J84.113')
episodios_cmbd <- fread("/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_CMBD.txt", header = T, encoding = "Latin-1") %>% 
  as.data.frame()
# cmbd_t <- as.data.frame(episodios_cmbd)

# TODO no hay fecha de ingreso en UCI. No podemos calcular dias UCIA. Mirar traslados. rafa: no creo que tengamos acceso a esto.

# dates need to be converted from the original source, missing means NO
episodios_cmbd$COD_FEC_INGRESO <- as.Date(as.character(episodios_cmbd$COD_FEC_INGRESO),format="%Y%m%d")
episodios_cmbd$COD_FEC_ALTA <- as.Date(as.character(episodios_cmbd$COD_FEC_ALTA),format="%Y%m%d")

# dias estancia hospitalaria
episodios_cmbd <- episodios_cmbd %>% 
  mutate(estancia_hospitalaria_dias = as.numeric(COD_FEC_ALTA - COD_FEC_INGRESO))

# dias entre infeccion e ingreso

# joining  the df containing infect_COVID_first_date

result <- left_join(episodios_cmbd, infect_COVID_first)

result <- result %>% 
  mutate(infeccion_ingreso_dias = infect_COVID_first_date - COD_FEC_INGRESO)


#  select only cols from names(episodios_cmbd)
episodios_cmbd <- result %>%
  select(NUHSA_ENCRIPTADO,COD_FEC_INGRESO,COD_FEC_ALTA,COD_TIPO_INGRESO,DESC_TIPO_INGRESO,COD_TIPO_ALTA,DESC_TIPO_ALTA,COD_D1,COD_D2,COD_D3,COD_D4,COD_D5,COD_D6,COD_D7,COD_D8,COD_D9,COD_D10,COD_D11,COD_D12,COD_D13,COD_D14,COD_D15,COD_D16,COD_D17,COD_D18,COD_D19,COD_D20,COD_P1,COD_P2,COD_P3,COD_P4,COD_P5,COD_P6,COD_P7,COD_P8,COD_P9,COD_P10,COD_P11,COD_P12,COD_P13,COD_P14,COD_P15,COD_P16,COD_P17,COD_P18,COD_P19,COD_P20,NUM_DIAS_UCI,estancia_hospitalaria_dias,infeccion_ingreso_dias, infect_COVID_first_date)

# estancia uci si/no
episodios_cmbd %<>% 
  mutate(icu_stay_bin = as.factor(if_else((NUM_DIAS_UCI == 0 | is.na(NUM_DIAS_UCI)),0,1)))

episodios_cmbd <- episodios_cmbd %>%   
  mutate(infeccion_alta_dias = infect_COVID_first_date - COD_FEC_ALTA)

# dias entre infeccion e ingreso hospitalario ha de ser de 30 días máximo. si no, no lo considero ingreso hospitalario por COVID
# los aún ingresados en el período de análisis habrían de tenerse en cuenta. Es menor de 30 si sale negativo también se cuenta.
episodios_cmbd <- episodios_cmbd %>% 
  mutate(hosp_stay_bin = if_else(infeccion_ingreso_dias >= -30 &
                                   infeccion_alta_dias <=0, 1 ,0))

# lo paso al sentido del nombre de la variable
episodios_cmbd <- episodios_cmbd %>% 
  mutate(infeccion_ingreso_dias = infeccion_ingreso_dias*-1,
         infeccion_alta_dias = infeccion_alta_dias*-1)
  
# episodios_cmbd %>%
#   # arrange(infeccion_alta_dias) %>%
#   filter(hosp_stay_bin == "1",
#          DESC_TIPO_ALTA == "Defunción") %>%
  # select(ingreso = COD_FEC_INGRESO, alta = COD_FEC_ALTA, dias_hosp = estancia_hospitalaria_dias,infect_COVID_first_date, infeccion_ingreso_dias, hosp_stay_bin, infeccion_alta_dias, DESC_TIPO_ALTA)

#we are just going to take into account first hospitalization
#filtramos los 5 códigos principales sólo por ICD relacionados con COVID, según conteo
# we are only selecting fist admission per patient
episodios_cmbd_first <- episodios_cmbd %>%
  select(
    NUHSA_ENCRIPTADO,
    COD_FEC_INGRESO,
    COD_FEC_ALTA,
    COD_TIPO_ALTA,
    DESC_TIPO_ALTA,
    hosp_stay_bin,
    estancia_hospitalaria_dias,
    icu_stay_bin,
    NUM_DIAS_UCI,
    COD_D1,
    COD_D2,
    COD_D3,
    COD_D4,
    COD_D5,
    infeccion_ingreso_dias
  ) %>%
  filter(hosp_stay_bin == 1) %>%
  filter(
    COD_D1 %in% icd_ofinterest | COD_D2 %in% icd_ofinterest | COD_D3 %in% icd_ofinterest | COD_D4 %in% icd_ofinterest | COD_D5 %in% icd_ofinterest
  ) %>%
  group_by(NUHSA_ENCRIPTADO) %>%
  filter(row_number() == 1) %>%
  select(
    NUHSA_ENCRIPTADO,
    COD_FEC_INGRESO,
    COD_FEC_ALTA,
    estancia_hospitalaria_dias,
    hosp_stay_bin,
    icu_stay_bin,
    infeccion_ingreso_dias
  )

remove(episodios_cmbd)
remove(result)
```

## vacunas

Jaime M

TODO address non european shots: grepl('COVID-19 Sinopharm|COVID-19 Sputnik V|COVID-19 Covishield|COVID-19 CoronaVac (Sinovac Biotech)|COVID-19 CanSinoBIO|COVID-19 Covaxin|COVID-19 HIPRA')

Criterios de exclusión: pacientes de 5 dosis.

-	Vacunas de la gripe de las campañas 2020-21 y 2021-2022.
-	Vacunas de neumococo en cualquier momento hasta el 31/03/2022.
-	Todas las vacunas relacionadas con el COVID 19 hasta el 31/03/2022.

TODO STAGI: *Pedir campañas 2019-20.* 

TODO hay varias vacunas de neumo y gripe por paciente.
TODO estudiar numero de infecciones
```{r}
vacunas_t <- vroom(
  "/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_VACUNAS_TODO.txt"
) %>%
  lazy_dt() %>%
  as.data.frame() %>% 
  left_join(.,infect_COVID_first,by = "NUHSA_ENCRIPTADO") %>% 
  mutate(
    FEC_VACUNACION = ymd(FEC_VACUNACION), # dates need to be converted from the original source, missing means NO
    vac_infecc_umbral = trunc((FEC_VACUNACION %--% infect_COVID_first_date) / days(1)) # dias entre vacunacion e infeccion
  )

#convertir los nombres de las vacunas en factores para disminuir coste de computación

vacunas_t <- vacunas_t %>% 
  mutate(NOM_VACUNA = as.factor(NOM_VACUNA))

# Y FILTRAR LAS VACUNAS QUE DESEAMOS
vacunas_t <- vacunas_t %>% 
  filter(NOM_VACUNA == "COVID-19 AstraZeneca"|
           NOM_VACUNA == "COVID-19 Janssen"|
           NOM_VACUNA == "COVID-19 Pfizer/BioNTech"|
           NOM_VACUNA == "COVID-19 Moderna"|
           NOM_VACUNA == "COVID-19 Novavax")
vacunas_t$NOM_VACUNA <- droplevels(vacunas_t$NOM_VACUNA)
         
# what shot was first per patient?
vacunas_t_covid_first <- vacunas_t %>%
  filter(vac_infecc_umbral >= 14) %>% # los dias entre la vacunacion e infeccion han de ser >= 14
  group_by(NUHSA_ENCRIPTADO) %>%
  arrange(FEC_VACUNACION) %>% 
  filter(row_number() == 1) %>% 
  transmute(
    NUHSA_ENCRIPTADO,
    covid_first_name = NOM_VACUNA,
    covid_first_date = FEC_VACUNACION
  )

# TODO cómo afecta el umbral de 14 días a la pauta completa?
# full shots
vacunas_t_covid_full <- vacunas_t %>%
  filter(vac_infecc_umbral >= 14) %>% # los dias entre la vacunacion e infeccion han de ser >= 14
  # ALVARO SERRANO: la linea anterior la introduzco el dia 22/02/2023. Al no estar en el codigo previamente, -->
  # estabamos considerando para cada paciente la ultima dosis puesta a fecha de extraccion de datos (mayo 2022 -->
  # si no recuerdo mal) y no hasta catorce dias antes de la infeccion, por lo que los analisis -->
  # incluyen datos erroneos e incurren en sesgos. Vamos, que no vale decir que con tres dosis te proteges -->
  # mas, basandose en estos datos. Seguramente sea asi, pero los resultados hechos con el codigo anterior -->
  # no deben fundamentar dicha afirmacion.
  group_by(NUHSA_ENCRIPTADO) %>%
  arrange(FEC_VACUNACION) %>% 
  filter(row_number()==3) %>% 
  transmute(
    NUHSA_ENCRIPTADO,
    covid_full_name = NOM_VACUNA,
    covid_full_date = FEC_VACUNACION
  )

# number of shots
vacunas_t_covid_pautas <- vacunas_t %>% 
  filter(vac_infecc_umbral >= 14) %>%
  # ALVARO SERRANO: idem a lo escrito en el pipeline anterior.
  group_by(NUHSA_ENCRIPTADO) %>%
  summarise(pautas_covid = n())

remove(vacunas_t)
```

# Joining across datasets

```{r}
print(Sys.time())
estudio_vacunas_t_final <- Reduce(function(...) merge(..., all.x=TRUE), list(
  infect_COVID_first
  , poblacion_diana 
  , pupa_opt
  , infect_COVID_num  
  , episodios_cmbd_first 
  , vacunas_t_covid_first
  , vacunas_t_covid_full
  , vacunas_t_covid_pautas
))
print(Sys.time())
```

# Selecting only required columns

```{r}
cols_to_exclude <- c("NUHSA_ENCRIPTADO", "COD_FEC_NACIMIENTO")
cols_to_include <- setdiff(names(estudio_vacunas_t_final), cols_to_exclude)
estudio_vacunas_t_final_selected <- estudio_vacunas_t_final %>% select(cols_to_include)
```

# New variables creation / adjustment

```{r}
estudio_vacunas_t_final_selected %<>%
  # Clean the column names using clean_names()
  clean_names() %>% 
  # Modify certain columns using mutate()
  mutate(
    # Set the infect_covid_first_date column to have a length of either 8 or 10 characters
    infect_covid_first_date = case_when(
      stri_length(as.character(infect_covid_first_date)) %in% c(8, 10) ~ infect_covid_first_date
    ),
    # Convert the hosp_stay_bin column to numeric
    hosp_stay_bin = as.numeric(hosp_stay_bin),
    # Convert the infeccion_ingreso_dias column to numeric
    infeccion_ingreso_dias = as.numeric(infeccion_ingreso_dias)
)


estudio_vacunas_t_final_selected %<>%
  mutate(  
    # Set the mortality30d column to 1 if the difference between fec_fallecimiento and infect_covid_first_date is less than 31 days, 0 otherwise
    mortality30d = case_when(
      (ymd(fec_fallecimiento) - infect_covid_first_date) < 31 ~ 1,
      T ~ 0
    ),
    # Set the estancia_hospitalaria_dias column to NA if hosp_stay_bin is not equal to 1, otherwise convert it to an integer
    estancia_hospitalaria_dias = case_when(
      hosp_stay_bin == 1 ~ as.integer(estancia_hospitalaria_dias),
      T ~ NA_integer_
    ),
    # Convert covid_first_name to character, replace NAs with "No vacunado", and convert to factor
    covid_first_name = as.character(covid_first_name),
    covid_first_name = if_else(is.na(covid_first_name), "No vac", covid_first_name),
    covid_first_name = factor(covid_first_name),
    # Convert covid_full_name to character, replace NAs with "No vacunado o vacunado con menos de tres dosis", and convert to factor
    covid_full_name = as.character(covid_full_name),
    covid_full_name = if_else(is.na(covid_full_name), "No vac or <3 shots", covid_full_name),
    covid_full_name = factor(covid_full_name),
    # Convert pautas_covid to an ordered factor
    pautas_covid = as.character(pautas_covid),
    pautas_covid = if_else(is.na(pautas_covid), "0", pautas_covid),
    pautas_covid = as.factor(pautas_covid)
  ) %>% 
  suppressWarnings()     

# grouping cancers by type
estudio_vacunas_t_final_selected %<>%
  mutate(cancer_organo_solido = 
    cancer_de_bronquio_y_pulmon | 
      cancer_de_cabeza_y_cuello |
      cancer_de_estomago |
      cancer_de_hueso_y_tejidos_blandos |
      cancer_de_mama |
      cancer_de_ovario |
      cancer_de_pancreas |
      cancer_de_prostata |
      cancer_de_rinon_y_pelvis_renal |
      cancer_de_testiculo |
      cancer_de_tiroides |
      cancer_de_utero |
      cancer_de_vejiga |
      cancer_de_cuello_uterino |
      melanoma_de_piel |
      sarcoma_de_kaposi,
    
    cancer_hematologico = 
      cancer_inmunoproliferativo |
        enfermedad_de_hodgkin |
        leucemia |
        linfoma_no_hodgkin
)

estudio_vacunas_t_final_selected %<>% 
  mutate(age_num = as.numeric(age),
         estancia_hospitalaria_dias = as.numeric(estancia_hospitalaria_dias),
         age_num_decada = age_num/10,
         cancer_organo_solido = as.numeric(cancer_organo_solido),
         cancer_organo_solido = if_else(is.na(cancer_organo_solido), 0, cancer_organo_solido),
         cancer_hematologico = as.numeric(cancer_hematologico),
         cancer_hematologico = if_else(is.na(cancer_hematologico), 0, cancer_hematologico),
         icu_stay_bin = as.numeric(as.character(icu_stay_bin))
         )

# we want the factors in no particular order
estudio_vacunas_t_final_selected <- estudio_vacunas_t_final_selected %>% 
  mutate_at(c("desc_sexo", "pautas_covid"), droplevels)
```

# Adressing missingness

## Mapping initial missingness

```{r}
# Count the number of missing values in each column of the data frame 
miss_count <- colSums(is.na(estudio_vacunas_t_final_selected))

# Calculate the percentage of missing values in each column
miss_percent <- round(miss_count / nrow(estudio_vacunas_t_final_selected) * 100,2)

# Order the results by the column names in the original data frame
ordered_miss_percent <- miss_percent[order(names(estudio_vacunas_t_final_selected))]

# Save the results in a new data frame
miss_percent_df <- data.frame(Column = names(ordered_miss_percent), Missing_Percent = ordered_miss_percent)
```

### Columns NA filling

```{r}
quien_tiene_na <- map_dfc(estudio_vacunas_t_final_selected, ~sum(is.na(.)))


fill_cols_to_exclude <- 
  estudio_vacunas_t_final_selected %>% 
  # ALVARO: hago lo siguiente para ahorrar tiempo, escribiendo asma:vih
  select(
    infect_covid_first_date, cod_sexo, desc_sexo, cod_municipio, desc_municipio,
    fec_fallecimiento, age, mortality, cod_fec_ingreso, cod_fec_alta,
    infeccion_ingreso_dias, covid_first_name, covid_first_date,
    covid_full_name, covid_full_date, pautas_covid, mortality30d,
    cancer_organo_solido, cancer_hematologico, age_num, age_num_decada
  ) %>% 
  colnames()
fill_cols_to_include <- setdiff(names(estudio_vacunas_t_final_selected), fill_cols_to_exclude)


# ALVARO: codigo "de seguridad" para vigilar que el lapply no la lie parda
summary_antes_lapply <- 
  estudio_vacunas_t_final_selected %>% 
  select(fill_cols_to_include) %>% 
  mutate(
    hosp_stay_bin = as.factor(hosp_stay_bin),
    icu_stay_bin = as.factor(icu_stay_bin)
  ) %>% 
  summary()
summary_antes_lapply


estudio_vacunas_t_final_selected[, fill_cols_to_include] <- 
  lapply(
    estudio_vacunas_t_final_selected[, fill_cols_to_include], 
    function(x) ifelse(is.na(x), 0, x)
  )


# ALVARO: codigo "de seguridad" para vigilar que el lapply no la lie parda
summary_despues_lapply <- 
  estudio_vacunas_t_final_selected %>% 
  select(fill_cols_to_include) %>% 
  mutate(
    hosp_stay_bin = as.factor(hosp_stay_bin),
    icu_stay_bin = as.factor(icu_stay_bin)
  ) %>% 
  summary()
summary_despues_lapply
```

### Mapping final missingness

```{r}
# Count the number of missing values in each column of the data frame 
miss_count <- colSums(is.na(estudio_vacunas_t_final_selected))

# Calculate the percentage of missing values in each column
miss_percent <- round(miss_count / nrow(estudio_vacunas_t_final_selected) * 100,2)

# Order the results by the column names in the original data frame
ordered_miss_percent <- miss_percent[order(names(estudio_vacunas_t_final_selected))]

# Save the results in a new data frame
miss_percent_df <- data.frame(Column = names(ordered_miss_percent), Missing_Percent = ordered_miss_percent)
```

# Exclusion criteria

No exclusion criteria by now.

```{r}
print('Número pacientes con infección COVID confirmada por PCR y fecha de infección disponible')
a<-nrow(estudio_vacunas_t_final_selected)
a

print('Pacientes excluídos con Sexo No Especificado')
estudio_vacunas_t_final_selected<-estudio_vacunas_t_final_selected %>% filter (desc_sexo %in% c('Hombre','Mujer') )
b<-nrow(estudio_vacunas_t_final_selected)
a-b

print('Pacientes excluídos con más de 4 dosis')
estudio_vacunas_t_final_selected<-estudio_vacunas_t_final_selected %>% filter (pautas_covid %in% c('0','1','2','3','4'))
c<-nrow(estudio_vacunas_t_final_selected)
b-c

print('Pacientes excluídos sin información de edad')
estudio_vacunas_t_final_selected%<>%filter(!is.na(age))
d<-nrow(estudio_vacunas_t_final_selected)
c-d
  
print('Número final de pacientes')
nrow(estudio_vacunas_t_final_selected)

estudio_vacunas_t_final_selected <- 
  estudio_vacunas_t_final_selected %>% 
  filter((covid_first_date > ymd(20201226)) | is.na(covid_first_date))
e <- nrow(estudio_vacunas_t_final_selected)
d-e

estudio_vacunas_t_final_selected <- 
  estudio_vacunas_t_final_selected %>% 
  filter(infect_covid_first_date > ymd(20200229))
f <- nrow(estudio_vacunas_t_final_selected)
e-f
```

# Saving Rds and Env

```{r}
saveRDS(estudio_vacunas_t_final_selected, file = "/opt/datos_compartidos/vacunas_data/Rfiles/estudio_vacunas_t_final_selected.rds")

# save.image(file='/opt/datos_compartidos/vacunas_data/Rfiles/vac_environment.RData')
```

