---
title: "Figures for the Andalusia COVID vaccines paper"
author: "Á Serrano-Ortiz & JL Romero-Cabrera; EPIDATA team"
output: 
  html_document:
    theme: lumen
---

```{r setup, include = FALSE}

library(tidyverse)
library(magrittr)
library(ggplot2)
library(janitor)
library(stringi)
library(stringr)
library(lubridate)
library(rio)
library(readr)
library(kableExtra)
library(networkD3)
library(rmarkdown)
library(gt)
library(tableone)
library(summarytools)
library(vroom)
library(mgcv)
library(parglm)
# library(lme4)
library(boot)
library(caTools)
library(caret)
library(pROC)

```



```{r, include = FALSE}

##################################################################################
####################### FUNCIONES Y VALORES PARAMETRIZADOS #######################
##################################################################################



# Función para leer archivos ""CSV"" (excel siempre dando problemas) y asignar nombres
# hashtag grasiaschatgptporenseñarnosR

leer_csv_carpeta <- function(ruta) {
  rutas_archivos <- list.files(path = ruta, pattern = ".xls", full.names = TRUE)
  lista <- list()
  for (i in seq_along(rutas_archivos)) {
    datos <- read_csv(rutas_archivos[i])
    nombre <- str_remove(rutas_archivos[i], fixed(ruta))
    datos <- datos %>% 
      mutate(
        outcome = if_else(
          grepl("intensivecare_only_hosp", nombre), 
          "intensivecare_only_hosp", 
          str_extract(nombre, "(?<=_)[^_]+")
        ),
        veffec = (1 - OR)*100,
        veffec_lower = (1 - OR_lower)*100,
        veffec_upper = (1 - OR_upper)*100
      ) %>% 
      select(outcome, everything())
    lista[[nombre]] <- datos
  }
  return(lista)
}



colours_variants <- c("#FFD92F", "#8DA0CB", "#A6D854", "#E78AC3")
colours_vaccines <- c("#D3BA68", "#D5695D", "#5D8CA8")
colours_2agegroups <- c("#C72E29", "#016392")
colours_3agegroups <- c("#C72E29", "#016392", "#BE9C2E")

```



## Sankey Plots {.tabset .tabset-fade .tabset-pills}

```{r, include = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

# CARGA Y DEFINICIÓN DE VARIABLES SEGÚN PARÁMETROS DE NUESTRO ESTUDIO

estudio_vacunas_t_final_selected <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/estudio_vacunas_t_final_selected_manuscript.rds") %>% 
  mutate(
    age_fct_3groups = case_when(
      age < 44 ~ "12-43 years old",
      age < 75 ~ "44-74 years old",
      age > 74 ~ "Over 74 years old",
      TRUE ~ NA_character_
    ),
    age_fct_3groups = factor(age_fct_3groups)
  )



# Vaccinated and unvaccinated population before positive CODIV-19 infection by RT-PCR
vacunados <- estudio_vacunas_t_final_selected %>% 
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres")) %>% nrow()

no_vacunados <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Ninguna")) %>% nrow()

vacunados + no_vacunados


# Hospital admission data
vacunados_ingresados <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & hosp_stay_bin == "Sí") %>% nrow()

vacunados_no_ingresados <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & hosp_stay_bin == "No") %>% nrow()

no_vacunados_ingresados <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Ninguna") & hosp_stay_bin == "Sí") %>% nrow()

no_vacunados_no_ingresados <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Ninguna") & hosp_stay_bin == "No") %>% nrow()

vacunados_ingresados + vacunados_no_ingresados + no_vacunados_ingresados + no_vacunados_no_ingresados


# ICU admission data
vacunados_ingresados_uci <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & icu_stay_bin == "Sí") %>% nrow()

vacunados_no_ingresados_uci <- estudio_vacunas_t_final_selected %>%
filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & icu_stay_bin == "No") %>% nrow()

no_vacunados_ingresados_uci <- estudio_vacunas_t_final_selected %>%
filter(n_vacunas_covid %in% c("Ninguna") & icu_stay_bin == "Sí") %>% nrow()

no_vacunados_no_ingresados_uci <- estudio_vacunas_t_final_selected %>% 
  filter(n_vacunas_covid %in% c("Ninguna") & icu_stay_bin == "No") %>% nrow()

vacunados_ingresados_uci + vacunados_no_ingresados_uci + no_vacunados_ingresados_uci + no_vacunados_no_ingresados_uci



# Mortality data
vacunados_muertos <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & mortality30d == "Sí") %>% nrow()

vacunados_vivos <- estudio_vacunas_t_final_selected %>% 
  filter(n_vacunas_covid %in% c("Una", "Dos", "Tres") & mortality30d == "No") %>% nrow()

no_vacunados_muertos <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Ninguna") & mortality30d == "Sí") %>% nrow()

no_vacunados_vivos <- estudio_vacunas_t_final_selected %>%
  filter(n_vacunas_covid %in% c("Ninguna") & mortality30d == "No") %>% nrow()

vacunados_muertos + vacunados_vivos + no_vacunados_muertos + no_vacunados_vivos



# Función básica para escalar valores sobre un valor total de 100
rescale_to100 <- function(value, total) {return((value/total)*100)}

total_estudio <- vacunados + no_vacunados

# values_and_values_reesc <- 
#   data.frame(
#     vacunados, no_vacunados, vacunados_ingresados, vacunados_no_ingresados, no_vacunados_ingresados,
#     no_vacunados_no_ingresados, vacunados_ingresados_uci, vacunados_no_ingresados_uci,
#     no_vacunados_ingresados_uci, no_vacunados_no_ingresados_uci, vacunados_muertos, vacunados_vivos, 
#     no_vacunados_muertos, no_vacunados_vivos
#   ) %>% 
#   pivot_longer(cols = everything()) %>% 
#   mutate(
#     name_reesc = paste0("reesc_", name),
#     value_reesc = rescale_to100(value = value, total = total_estudio)
#   ) %>% 
#   select(name_reesc, value_reesc) %>% 
#   pivot_wider(names_from = name_reesc, values_from = value_reesc)



# Utiliza map para extraer las columnas y crear una lista de objetos

# map(colnames(values_and_values_reesc), ~values_and_values_reesc %>% select(.x) %>% pull()) %>% 
#   set_names(colnames(values_and_values_reesc)) %>% 
#   walk2(.x = ., .y = names(.), ~assign(.y, .x, envir = .GlobalEnv))

# reesc_total_estudio <- 100

```





```{r, include = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

### BANCO DE PRUEBAS **NO TOCAR**





# Altura del eje x en 100 + 20 (que será el hueco entre bloques)

# panel_height <- 110
# start_y_panel_a <- 10
# gap <- 10
# start_x_panel_a <- 0; end_x_panel_a <- 20
# start_x_panel_b <- 60; end_x_panel_b <- 80
# start_x_panel_c <- 120; end_x_panel_c <- 140



# Polígono inicial, el total. No hay que añadirle valores

# polygon_a <- 
#   data.frame(
#     x = c(start_x_panel_a, start_x_panel_a, end_x_panel_a, end_x_panel_a), 
#     y = c(start_y_panel_a, panel_height, panel_height, start_y_panel_a)
#   )



# Polígonos intermedios. Funciones para no repetir código

# polygon_b_down <- 
#   data.frame(
#     x = c(start_x_panel_b, start_x_panel_b, end_x_panel_b, end_x_panel_b),
#     y = c(0, reesc_no_vacunados, reesc_no_vacunados, 0)
#   )
# polygon_b_up <- 
#   data.frame(
#     x = c(start_x_panel_b, start_x_panel_b, end_x_panel_b, end_x_panel_b),
#     y = c(reesc_no_vacunados + gap, panel_height, panel_height, reesc_no_vacunados + gap)
#   )



# Polígonos finales. Funciones para no repetir código

# polygon_c_down <- 
#   data.frame(
#     x = c(start_x_panel_c, start_x_panel_c, end_x_panel_c, end_x_panel_c),
#     y = c(
#       0, 
#       reesc_no_vacunados_ingresados + reesc_vacunados_ingresados, 
#       reesc_no_vacunados_ingresados + reesc_vacunados_ingresados, 
#       0
#     )
#   )
# polygon_c_up <- 
#   data.frame(
#     x = c(start_x_panel_c, start_x_panel_c, end_x_panel_c, end_x_panel_c),
#     y = c(
#       reesc_no_vacunados_ingresados + reesc_vacunados_ingresados + gap, 
#       panel_height, 
#       panel_height, 
#       reesc_no_vacunados_ingresados + reesc_vacunados_ingresados + gap
#     )
#   )





# Ajuste del parámetro de escala (mayor valor para menor pendiente de la curva sigmoidea)

# scale_factor <- 7

# Definición del conjunto de 200 valores de x para las secciones ab y bc (inicial-interm e interm-final)

# x_values_ab <- seq(from = end_x_panel_a, to = start_x_panel_b, length.out = 200)
# x_values_bc <- seq(from = end_x_panel_b, to = start_x_panel_c, length.out = 200)

# Definición de los puntos de inflexión. Deben ser el punto medio entre el punto de partida y el de llegada

# inflection_point_ab <- x_values_ab[1] + (rev(x_values_ab)[1] - x_values_ab[1])/2
# inflection_point_bc <- x_values_bc[1] + (rev(x_values_bc)[1] - x_values_bc[1])/2



# Definición de la función sigmoide ab, con un punto de inflexión y un parámetro de escala específicos

# y_sigm_ab <- 1/(1 + exp(-(x_values_ab - inflection_point_ab)/scale_factor))

# Escalado de los valores de y a los rangos deseados en ab (colocado de la línea a la altura deseada)
### Flujo ab inferior: 

# create_y_ab_down <- 
#   function(y) {
#     return(start_y_panel_a + (y - min(y))*(polygon_b_down[1, 2] - start_y_panel_a)/(max(y) - min(y)))
#   }

# Creación de bordes sigmoidales superior e inferior del flujo inferior

# y_sigm_ab_down_lower <- create_y_ab_down(y_sigm_ab)
# y_sigm_ab_down_upper <- y_sigm_ab_down_lower + reesc_no_vacunados

# Creación de los polígonos de los flujos ab

# flux_ab_down <- 
#   data.frame(
#     x = c(x_values_ab, rev(x_values_ab)),
#     y = c(y_sigm_ab_down_lower, rev(y_sigm_ab_down_upper))
#   )
# flux_ab_up <- 
#   data.frame(
#     x = c(end_x_panel_a, end_x_panel_a, start_x_panel_b, start_x_panel_b),
#     y = c(reesc_no_vacunados + gap, panel_height, panel_height, reesc_no_vacunados + gap)
#   )



# Definición de la función sigmoide bc, con un punto de inflexión y un parámetro de escala específicos

# y_sigm_bc <- 1/(1 + exp(-(x_values_bc - inflection_point_bc)/scale_factor))

# Escalado de los valores de y a los rangos deseados en bc (colocado de la línea a la altura deseada)
### Flujo superior-inferior: 

# scale_y_bc_updown <- 
  # function(y) {
    # return(
      # polygon_b_up[1, 2] + 
        # (y - min(y))*
        # ((polygon_c_down[2, 2] - reesc_vacunados_ingresados) - polygon_b_up[1, 2])/(max(y) - min(y))
    # )
  # }

### Flujo ab inferior-superior:

# scale_y_bc_downup <-
#   function(y) {
#     return(
#       reesc_no_vacunados_ingresados + 
#         (y - min(y))*(polygon_c_up[1, 2] - reesc_no_vacunados_ingresados)/(max(y) - min(y))
#     )
#   }

# Creación de bordes sigmoidales superior e inferior de los flujos superior-inferior e inferior-superior

# y_sigm_bc_updown_lower <- scale_y_bc_updown(y_sigm_bc)
# y_sigm_bc_updown_upper <- y_sigm_bc_updown_lower + reesc_vacunados_ingresados
# y_sigm_bc_downup_lower <- scale_y_bc_downup(y_sigm_bc)
# y_sigm_bc_downup_upper <- y_sigm_bc_downup_lower + reesc_no_vacunados_no_ingresados

# Creación de los polígonos de los flujos bc

# flux_bc_updown <- 
#   data.frame(
#     x = c(x_values_bc, rev(x_values_bc)),
#     y = c(y_sigm_bc_updown_lower, rev(y_sigm_bc_updown_upper))
#   )
# flux_bc_downup <- 
#   data.frame(
#     x = c(x_values_bc, rev(x_values_bc)),
#     y = c(y_sigm_bc_downup_lower, rev(y_sigm_bc_downup_upper))
#   )
# flux_bc_upup <- 
#   data.frame(
#     x = c(end_x_panel_b, end_x_panel_b, start_x_panel_c, start_x_panel_c),
#     y = c(
#       reesc_no_vacunados + gap + reesc_vacunados_ingresados, 
#       panel_height, 
#       panel_height, 
#       reesc_no_vacunados + gap + reesc_vacunados_ingresados
#     )
#   )
# flux_bc_downdown <- 
#   data.frame(
#     x = c(end_x_panel_b, end_x_panel_b, start_x_panel_c, start_x_panel_c),
#     y = c(0, reesc_no_vacunados_ingresados, reesc_no_vacunados_ingresados, 0)
#   )



# Creación del gráfico

# ggplot() +
  # FLUJOS
  # geom_polygon(data = flux_ab_down, mapping = aes(x, y), fill = "salmon", color = NA) +
  # geom_polygon(data = flux_ab_up, mapping = aes(x, y), fill = "navyblue", color = NA) +
  # geom_polygon(data = flux_bc_downup, mapping = aes(x, y), fill = "pink", color = NA) +
  # geom_polygon(data = flux_bc_updown, mapping = aes(x, y), fill = "skyblue", color = NA) +
  # geom_polygon(data = flux_bc_upup, mapping = aes(x, y), fill = "skyblue", color = NA) +
  # geom_polygon(data = flux_bc_downdown, mapping = aes(x, y), fill = "skyblue", color = NA) +
  # CAJAS
  # geom_polygon(data = polygon_a, aes(x, y), fill = "grey60", color = "black") +
  # geom_polygon(data = polygon_b_down, aes(x, y), fill = "green1", color = "black") +
  # geom_polygon(data = polygon_b_up, aes(x, y), fill = "green4", color = "black") +
  # geom_polygon(data = polygon_c_down, aes(x, y), fill = "red1", color = "black") +
  # geom_polygon(data = polygon_c_up, aes(x, y), fill = "red4", color = "black") +

  # ADEREZOS
  # labs(title = "ea, conseguido", x = "Eje X", y = "Eje Y") +
  # theme_void()

```





```{r, include = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

##############################################################
##############################################################
###################### PUEDES REDEFINIR ######################
####################### ESTOS OBJETOS ########################
##############################################################
##############################################################
############ SON COMUNES A LOS TRES SANKEY PLOTS #############
##############################################################
##############################################################

color_fill_polygon_a <- "gray75"; color_polygon_a <- "gray50"
color_fill_polygon_b_down <- "#ECCB50"; color_polygon_b_down <- "#AA8A13"
color_fill_polygon_b_up <- "#5570EC"; color_polygon_b_up <- "#1436D6"
color_fill_polygon_c_down <- "#F73A5F"; color_polygon_c_down <- "#ED002F"
color_fill_polygon_c_up <- "#35DF7F"; color_polygon_c_up <- "#00B950"
color_flux_ab_down <- "#FFE279"
color_flux_ab_up <- "#7A8FF2"
color_flux_bc_uptoup <- "#5BE898"
color_flux_bc_uptodown <- "#F9617F"
color_flux_bc_downtoup <- "#5BE898"
color_flux_bc_downtodown <- "#F9617F"

```



```{r, include = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

##############################################################
##############################################################
########################## FUNCIONES #########################
##############################################################
##############################################################
############ MATERIAL INDEPENDIENTE DE TUS DATOS; ############
########################## NO TOCAR ##########################
##################### SALVO EXPERIMENTOS #####################
##############################################################
##############################################################
############# NO NECESITAS ENTENDER ESTE CÓDIGO ##############
##############################################################
##############################################################



##########################################
# POLÍGONOS DE CAJAS/GRUPOS
##########################################

# Definición de la altura del eje x en 100 (total percentual) + 10 (que será el hueco entre bloques)
panel_height <- 110; start_y_panel_a <- 10
gap <- 10

# Definición de los puntos en x de inicio y final de las cajas
# He definido el grosor de los paneles y la longitud de las conexiones o flujos a ojímetro; quedan bien
# a = CAJA INICIAL, b = CAJAS INTERMEDIAS, c = CAJAS FINALES
start_x_panel_a <- 0; end_x_panel_a <- 20
start_x_panel_b <- 60; end_x_panel_b <- 80
start_x_panel_c <- 120; end_x_panel_c <- 140

# Polígono inicial, el total. El objeto puede definirse directamente, no hay que generarlo mediante función
polygon_a <- 
  data.frame(
    x = c(start_x_panel_a, start_x_panel_a, end_x_panel_a, end_x_panel_a), 
    y = c(start_y_panel_a, panel_height, panel_height, start_y_panel_a)
  )

# Polígonos intermedios. Funciones para generar tamaños en base a distribución de frecuencias de los grupos
create_polygon_b_down <- 
  function(value_percent_b_down) {
    return(data.frame(
      x = c(start_x_panel_b, start_x_panel_b, end_x_panel_b, end_x_panel_b),
      y = c(0, value_percent_b_down, value_percent_b_down, 0)
    ))
  }
create_polygon_b_up <- 
  function(value_percent_b_down) {
    return(data.frame(
      x = c(start_x_panel_b, start_x_panel_b, end_x_panel_b, end_x_panel_b),
      y = c(
        value_percent_b_down + gap, 
        panel_height, 
        panel_height, 
        value_percent_b_down + gap
      ))
    )
  }

# Polígonos finales. Funciones para generar tamaños en base a distribución de frecuencias de los grupos
create_polygon_c_down <- 
  function(value_percent_c_down) {
    return(data.frame(
      x = c(start_x_panel_c, start_x_panel_c, end_x_panel_c, end_x_panel_c),
      y = c(0, value_percent_c_down, value_percent_c_down, 0)
    ))
  }
create_polygon_c_up <- 
  function(value_percent_c_down) {
    return(data.frame(
      x = c(start_x_panel_c, start_x_panel_c, end_x_panel_c, end_x_panel_c),
      y = c(
        value_percent_c_down + gap,
        panel_height,
        panel_height,
        value_percent_c_down + gap
      )
    ))
  }



##########################################
# POLÍGONOS DE FLUJOS
##########################################

# Ajuste del parámetro de escala (mayor valor para menor pendiente de las curvas sigmoideas)
scale_factor <- 7

# Definición del conjunto de 200 valores de x para las secciones ab y bc (inicial-interm e interm-final)
x_values_ab <- seq(from = end_x_panel_a, to = start_x_panel_b, length.out = 600)
x_values_bc <- seq(from = end_x_panel_b, to = start_x_panel_c, length.out = 600)

# Definición de los puntos de inflexión. Deben ser el punto medio entre el punto de partida y el de llegada
inflection_point_ab <- x_values_ab[1] + (rev(x_values_ab)[1] - x_values_ab[1])/2
inflection_point_bc <- x_values_bc[1] + (rev(x_values_bc)[1] - x_values_bc[1])/2

# Definición de la funciones sigmoides ab y bc, usando los puntos de inflexión y parámetros de escala definidos
y_sigm_ab <- 1/(1 + exp(-(x_values_ab - inflection_point_ab)/scale_factor))
y_sigm_bc <- 1/(1 + exp(-(x_values_bc - inflection_point_bc)/scale_factor))

# Escalado de los valores de y a los rangos deseados para el flujo ab inferior = ajuste a la altura deseada
create_y_ab_down_lower <- 
  function(y) {
    return(start_y_panel_a + (y - min(y))*(polygon_b_down[1, 2] - start_y_panel_a)/(max(y) - min(y)))
  }
create_y_ab_down_upper <- function(y) {return(create_y_ab_down_lower(y) + value_percent_b_down)}

# Escalado de los valores de y a los rangos deseados para los flujos bc = ajuste a la altura deseada
### Flujo superior-inferior: 
create_y_bc_uptodown_lower <- 
  function(y) {
    return(
      polygon_b_up[1, 2] + 
        (y - min(y))*
        ((polygon_c_down[2, 2] - value_percent_c_sub_uptodown) - polygon_b_up[1, 2])/(max(y) - min(y)) 
    )
  }
create_y_bc_uptodown_upper <- 
  function(y) {return(create_y_bc_uptodown_lower(y) + value_percent_c_sub_uptodown)}

### Flujo ab inferior-superior:
create_y_bc_downtoup_lower <-
  function(y) {
    return(
      value_percent_c_sub_downtodown + 
        (y - min(y))*(polygon_c_up[1, 2] - value_percent_c_sub_downtodown)/(max(y) - min(y))
    )
  }
create_y_bc_downtoup_upper <- 
  function(y) {return(create_y_bc_downtoup_lower(y) + value_percent_c_sub_downtoup)}

# Creación de los polígonos de los flujos ab
create_flux_ab_down <- 
  function(y) {
    return(data.frame(
      x = c(x_values_ab, rev(x_values_ab)),
      y = c(create_y_ab_down_lower(y), rev(create_y_ab_down_upper(y)))
    ))
  }
create_flux_ab_up <- 
  function() {
  return(data.frame(
      x = c(end_x_panel_a, end_x_panel_a, start_x_panel_b, start_x_panel_b),
      y = c(value_percent_b_down + gap, panel_height, panel_height, value_percent_b_down + gap)
    ))
  }

# Creación de los polígonos de los flujos bc
create_flux_bc_uptodown <- 
  function(y) {
    return(data.frame(
      x = c(x_values_bc, rev(x_values_bc)),
      y = c(create_y_bc_uptodown_lower(y), rev(create_y_bc_uptodown_upper(y)))
    ))
  }
create_flux_bc_downtoup <- 
  function(y) {
    return(data.frame(
      x = c(x_values_bc, rev(x_values_bc)),
      y = c(create_y_bc_downtoup_lower(y), rev(create_y_bc_downtoup_upper(y)))
    ))
  }
create_flux_bc_uptoup <- 
  function() {
    return(data.frame(
      x = c(end_x_panel_b, end_x_panel_b, start_x_panel_c, start_x_panel_c),
      y = c(
        value_percent_b_down + gap + value_percent_c_sub_uptodown, 
        panel_height, 
        panel_height, 
        value_percent_b_down + gap + value_percent_c_sub_uptodown
      )
    ))
  }
create_flux_bc_downtodown <- 
  function() {
    return(data.frame(
      x = c(end_x_panel_b, end_x_panel_b, start_x_panel_c, start_x_panel_c),
      y = c(0, value_percent_c_sub_downtodown, value_percent_c_sub_downtodown, 0)
    ))
  }



##########################################
# SANKEY PLOT
##########################################

# Creación del gráfico mediante una función
create_sankey_plot <- 
  function() {
    ggplot() +
      # FLUJOS
      geom_polygon(data = flux_ab_down, mapping = aes(x, y), fill = color_flux_ab_down, color = NA) +
      geom_polygon(data = flux_ab_up, mapping = aes(x, y), fill = color_flux_ab_up, color = NA) +
      geom_polygon(data = flux_bc_uptoup, mapping = aes(x, y), fill = color_flux_bc_uptoup, color = NA) +
      geom_polygon(data = flux_bc_downtoup, mapping = aes(x, y), fill = color_flux_bc_downtoup, color = NA) +
      geom_polygon(data = flux_bc_uptodown, mapping = aes(x, y), fill = color_flux_bc_uptodown, color = NA) +
      geom_polygon(data = flux_bc_downtodown, mapping = aes(x, y), fill = color_flux_bc_downtodown, color = NA) +
      # CAJA A
      geom_polygon(
        data = polygon_a, aes(x, y), 
        fill = color_fill_polygon_a, color = color_polygon_a
      ) +
      geom_text(
        aes(x = end_x_panel_a/2, y = (panel_height - start_y_panel_a)/2 + start_y_panel_a), 
        label = box_a_name, colour = "black", fontface = "bold", size = 2.5
      ) +
      # CAJA B DOWN
      geom_polygon(
        data = polygon_b_down, aes(x, y), 
        fill = color_fill_polygon_b_down, color = color_polygon_b_down
      ) +
      geom_text(
        aes(
          x = (end_x_panel_b - start_x_panel_b)/2 + start_x_panel_b, 
          y = polygon_b_down[2, 2]/2
        ), 
        label = box_b_down_name, colour = "black", fontface = "bold", size = 2.5
      ) +
      # CAJA B UP
      geom_polygon(
        data = polygon_b_up, aes(x, y),
        fill = color_fill_polygon_b_up, color = color_polygon_b_up
      ) +
      geom_text(
        aes(
          x = (end_x_panel_b - start_x_panel_b)/2 + start_x_panel_b, 
          y = (polygon_b_up[2, 2] - polygon_b_up[1, 2])/2 + polygon_b_up[1, 2]
        ), 
        label = box_b_up_name, colour = "black", fontface = "bold", size = 2.5
      ) +
      # CAJA C DOWN
      geom_polygon(
        data = polygon_c_down, aes(x, y), 
        fill = color_fill_polygon_c_down, color = color_polygon_c_down
      ) +
      geom_text(
        aes(
          x = (end_x_panel_c - start_x_panel_c)/2 + start_x_panel_c, 
          y = polygon_c_down[2, 2]/2
        ), 
        label = box_c_down_name, colour = "black", fontface = "bold", size = 2.5, hjust = 0, nudge_x = 12
      ) +
      # CAJA C UP
      geom_polygon(
        data = polygon_c_up, aes(x, y), 
        fill = color_fill_polygon_c_up, color = color_polygon_c_up
      ) +
      geom_text(
        aes(
          x = (end_x_panel_c - start_x_panel_c)/2 + start_x_panel_c, 
          y = (polygon_c_up[2, 2] - polygon_c_up[1, 2])/2 + polygon_c_up[1, 2]
        ), 
        label = box_c_up_name, colour = "black", fontface = "bold", size = 2.5, hjust = 0, nudge_x = 12
      ) +
      # ADEREZOS
      scale_x_continuous(limits = c(0, 160)) +
      labs(title = plot_title, x = NULL, y = NULL) +
      theme_void()
  }



# Proceso completo para obtener el sankey
plot_my_sankey <- 
  function() {
    necessary_values_names <<- 
      c(
        "value_percent_b_down", "value_percent_c_down", "value_percent_c_sub_uptodown",
        "value_percent_c_sub_downtodown", "value_percent_c_sub_downtoup", "plot_title",
        "box_a_name", "box_b_down_name", "box_b_up_name", "box_c_down_name", "box_c_up_name"
      )
    objects_not_created_index <- necessary_values_names %>% map_lgl(~!exists(.x))
    objects_not_created <- necessary_values_names[objects_not_created_index]
    if (!is_empty(objects_not_created)) {
      print(paste0(
        "Los siguientes objetos no existen, y deben crearse para poder generar el gráfico: ", 
        paste(objects_not_created, collapse = ", ")
      ))
    } else {
      print("Has cargado los datos correctamente. Aquí tienes tu gráfico:");
      polygon_b_down <<- create_polygon_b_down(value_percent_b_down);
      polygon_b_up <<- create_polygon_b_up(value_percent_b_down);
      polygon_c_down <<- create_polygon_c_down(value_percent_c_down);
      polygon_c_up <<- create_polygon_c_up(value_percent_c_down);
      flux_ab_down <<- create_flux_ab_down(y_sigm_ab);
      flux_ab_up <<- create_flux_ab_up();
      flux_bc_uptoup <<- create_flux_bc_uptoup();
      flux_bc_uptodown <<- create_flux_bc_uptodown(y_sigm_bc);
      flux_bc_downtoup <<- create_flux_bc_downtoup(y_sigm_bc);
      flux_bc_downtodown <<- create_flux_bc_downtodown();
      create_sankey_plot()
    }
  }

```



### New sankey plot for Hospital Admission

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

##########################################
# DEBES CREAR LOS SIGUIENTES OBJETOS
##########################################

# TODO aplicar la formula de reescalado directamente aquí, mucho mejor
value_percent_b_down <- rescale_to100(no_vacunados, total = total_estudio)
value_percent_c_down <- rescale_to100(vacunados_ingresados + no_vacunados_ingresados, total = total_estudio)
value_percent_c_sub_uptodown <- rescale_to100(vacunados_ingresados, total = total_estudio)
value_percent_c_sub_downtodown <- rescale_to100(no_vacunados_ingresados, total = total_estudio)
value_percent_c_sub_downtoup <- rescale_to100(no_vacunados_no_ingresados, total = total_estudio)
plot_title <- "Sample distribution flows towards hospital admission"
box_a_name <- paste0("Study sample\n(n = ", total_estudio, ")")
box_b_down_name <- paste0("Not vaccinated\n(n = ", no_vacunados, ")")
box_b_up_name <- paste0("Vaccinated\n(n = ", vacunados, ")")
box_c_down_name <- 
  paste0("Required\nhospital admission\n(n = ", vacunados_ingresados + no_vacunados_ingresados, ")")
box_c_up_name <- 
  paste0("Did not require\nhospital admission\n(n = ", vacunados_no_ingresados + no_vacunados_no_ingresados, ")")

##########################################
# DEBES CREAR LOS OBJETOS ANTERIORES
##########################################



##########################################
# NO MODIFIQUES EL SIGUIENTE CÓDIGO;
# SÓLO EJECÚTALO PARA 
# OBTENER EL SANKEY PLOT
##########################################

plot_my_sankey()



# Sieeeeeemmpre al final de cada sankey hay que borrar los objetos, para que al
# siguiente sankey se pueda reusar el if statement!!!

remove(list = necessary_values_names)

```

### New sankey plot for ICU Admission

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

##########################################
# DEBES CREAR LOS SIGUIENTES OBJETOS
##########################################

# TODO aplicar la formula de reescalado directamente aquí, mucho mejor
value_percent_b_down <- rescale_to100(no_vacunados, total = total_estudio)
value_percent_c_down <- 
  rescale_to100(vacunados_ingresados_uci + no_vacunados_ingresados_uci, total = total_estudio)
value_percent_c_sub_uptodown <- rescale_to100(vacunados_ingresados_uci, total = total_estudio)
value_percent_c_sub_downtodown <- rescale_to100(no_vacunados_ingresados_uci, total = total_estudio)
value_percent_c_sub_downtoup <- rescale_to100(no_vacunados_no_ingresados_uci, total = total_estudio)
plot_title <- "Sample distribution flows towards ICU admission"
box_a_name <- paste0("Study sample\n(n = ", total_estudio, ")")
box_b_down_name <- paste0("Not vaccinated\n(n = ", no_vacunados, ")")
box_b_up_name <- paste0("Vaccinated\n(n = ", vacunados, ")")
box_c_down_name <- 
  paste0("Required\nadmission to ICU\n(n = ", vacunados_ingresados_uci + no_vacunados_ingresados_uci, ")")
box_c_up_name <- 
  paste0("Did not require\nadmission to ICU\n(n = ", vacunados_no_ingresados_uci + no_vacunados_no_ingresados_uci, ")")

##########################################
# DEBES CREAR LOS OBJETOS ANTERIORES
##########################################



##########################################
# NO MODIFIQUES EL SIGUIENTE CÓDIGO;
# SÓLO EJECÚTALO PARA 
# OBTENER EL SANKEY PLOT
##########################################

plot_my_sankey()



# Sieeeeeemmpre al final de cada sankey hay que borrar los objetos, para que al
# siguiente sankey se pueda reusar el if statement!!!

remove(list = necessary_values_names)

```

### New sankey plot for mortality

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

##########################################
# DEBES CREAR LOS SIGUIENTES OBJETOS
##########################################

# TODO aplicar la formula de reescalado directamente aquí, mucho mejor
value_percent_b_down <- rescale_to100(no_vacunados, total = total_estudio)
value_percent_c_down <- rescale_to100(vacunados_muertos + no_vacunados_muertos, total = total_estudio)
value_percent_c_sub_uptodown <- rescale_to100(vacunados_muertos, total = total_estudio)
value_percent_c_sub_downtodown <- rescale_to100(no_vacunados_muertos, total = total_estudio)
value_percent_c_sub_downtoup <- rescale_to100(no_vacunados_vivos, total = total_estudio)
plot_title <- "Sample distribution flows towards mortality"
box_a_name <- paste0("Study sample\n(n = ", total_estudio, ")")
box_b_down_name <- paste0("Not vaccinated\n(n = ", no_vacunados, ")")
box_b_up_name <- paste0("Vaccinated\n(n = ", vacunados, ")")
box_c_down_name <- 
  paste0("Deceased\n(n = ", vacunados_muertos + no_vacunados_muertos, ")")
box_c_up_name <- 
  paste0("Surviving\n(n = ", vacunados_vivos + no_vacunados_vivos, ")")

##########################################
# DEBES CREAR LOS OBJETOS ANTERIORES
##########################################



##########################################
# NO MODIFIQUES EL SIGUIENTE CÓDIGO;
# SÓLO EJECÚTALO PARA 
# OBTENER EL SANKEY PLOT
##########################################

plot_my_sankey()



# Sieeeeeemmpre al final de cada sankey hay que borrar los objetos, para que al
# siguiente sankey se pueda reusar el if statement!!!

remove(list = necessary_values_names)

```





### Sankey Plot for Hospital Admission

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

# Name of nodes
pobl <- "Población de estudio"
vac <- "Vacunados"
novac <- "No Vacunados"
nohosp <- "No Hospitalizados"
hosp <- "Hospitalizados"

# Make a connection data frame
source <- c(pobl, pobl, vac, vac, novac, novac)
target <- c(vac, novac, nohosp, hosp, nohosp, hosp)
value <- 
  c(
    vacunados, no_vacunados, vacunados_no_ingresados,
    vacunados_ingresados, no_vacunados_no_ingresados, no_vacunados_ingresados
  )
data <- data.frame(source, target, value)

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame("name" = c(as.character(data$source), as.character(data$target) %>% unique()))

# With networkD3, connection must be provided using id, not using real name like in the links dataframe. So we need to reformat it.
data$IDsource <- match(data$source, nodes$name) - 1
data$IDtarget <- match(data$target, nodes$name) - 1

## Add link types for coloring purpose
data$group <- 
  as.factor(c("type_0", "type_0", "type_1", "type_2", "type_1", "type_2"))

# Add a 'group' column to each node.
nodes$group <- 
  as.factor(c("node1", "node1", "node2", "node2", "node3", "node3", "node2", "node3", "node4", "node5"))

# Give a color for each group
my_color <- 'd3.scaleOrdinal() .domain(["type_0", "type_1", "type_2", "node1", "node2", "node3", "node4", "node5"]) .range(["#a4b0be", "#7bed9f", "#ff6b81", "#747d8c", "#70a1ff", "#eccc68", "#2ed573", "#ff4757"])'

# Create the Sankey diagram
SankeyDiagram <- sankeyNetwork(
  Links = data,
  Nodes = nodes,
  Source = "IDsource",
  Target = "IDtarget",
  Value = "value",
  NodeID = "name",
  colourScale = my_color,
  LinkGroup = "group",
  NodeGroup = "group",
  fontSize = 16,
  fontFamily = 34,
  nodeWidth = 100,
  nodePadding = 20,
  height = 400,
  width = 1100,
  iterations = 32,
  sinksRight = FALSE
)

# Print the Sankey diagram
SankeyDiagram


```

### Sankey Plot for UCI Admission


```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}
#Name of nodes
A <- "Población de estudio"
B <- "Vacunados"
C <- "No Vacunados"
G <- "No Ingresados en UCI"
H <- "Ingresados en UCI"

# Make a connection data frame
source <- c(A, A, B, B, C, C)
target <- c(B, C, G, H, G, H)
value <- c(vacunados, no_vacunados, vacunados_no_ingresados_uci, vacunados_ingresados_uci, no_vacunados_no_ingresados_uci, no_vacunados_ingresados_uci)
data <- data.frame(source, target, value)

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <-
  data.frame("name" = c(
    as.character(data$source),
    as.character(data$target)
    %>% unique()
  ))

# With networkD3, connection must be provided using id, not using real name like in the links dataframe. So we need to reformat it.
data$IDsource <- match(data$source, nodes$name) - 1
data$IDtarget <- match(data$target, nodes$name) - 1


## Add link types for coloring purpose
data$group = as.factor(c("type_0",
                         "type_0",
                         "type_1",
                         "type_2",
                         "type_1",
                         "type_2"))

# Add a 'group' column to each node.
nodes$group <-
  as.factor(
    c(
      "node1",
      "node1",
      "node2",
      "node2",
      "node3",
      "node3",
      "node2",
      "node3",
      "node4",
      "node5"
    )
  )

# Give a color for each group
my_color <-
  'd3.scaleOrdinal() .domain(["type_0", "type_1", "type_2", "node1", "node2", "node3", "node4", "node5"]) .range(["#a4b0be", "#7bed9f", "#ff6b81", "#747d8c", "#70a1ff", "#eccc68", "#2ed573", "#ff4757"])'

# Create the Sankey diagram
SankeyDiagram <- sankeyNetwork(
  Links = data,
  Nodes = nodes,
  Source = "IDsource",
  Target = "IDtarget",
  Value = "value",
  NodeID = "name",
  colourScale = my_color,
  LinkGroup = "group",
  NodeGroup = "group",
  fontSize = 16,
  fontFamily = 34,
  nodeWidth = 100,
  nodePadding = 20,
  height = 400,
  width = 1100,
  iterations = 32,
  sinksRight = FALSE
)

# Print the Sankey diagram
SankeyDiagram

```

### Sankey Plot for Mortality


```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}
#Name of nodes
A <- "Población de estudio"
B <- "Vacunados"
C <- "No Vacunados"
I <- "Supervivientes"
J <- "Fallecidos"

# Make a connection data frame
source <- c(A, A, B, B, C, C)
target <- c(B, C, I, J, I, J)
value <- c(vacunados, no_vacunados, vacunados_vivos, vacunados_muertos, no_vacunados_vivos, no_vacunados_muertos)
data <- data.frame(source, target, value)

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <-
  data.frame("name" = c(
    as.character(data$source),
    as.character(data$target)
    %>% unique()
  ))

# With networkD3, connection must be provided using id, not using real name like in the links dataframe. So we need to reformat it.
data$IDsource <- match(data$source, nodes$name) - 1
data$IDtarget <- match(data$target, nodes$name) - 1


## Add link types for coloring purpose
data$group = as.factor(c("type_0",
                         "type_0",
                         "type_1",
                         "type_2",
                         "type_1",
                         "type_2"))

# Add a 'group' column to each node.
nodes$group <-
  as.factor(
    c(
      "node1",
      "node1",
      "node2",
      "node2",
      "node3",
      "node3",
      "node2",
      "node3",
      "node4",
      "node5"
    )
  )

# Give a color for each group
my_color <-
  'd3.scaleOrdinal() .domain(["type_0", "type_1", "type_2", "node1", "node2", "node3", "node4", "node5"]) .range(["#a4b0be", "#7bed9f", "#ff6b81", "#747d8c", "#70a1ff", "#eccc68", "#2ed573", "#ff4757"])'

# Create the Sankey diagram
SankeyDiagram <- sankeyNetwork(
  Links = data,
  Nodes = nodes,
  Source = "IDsource",
  Target = "IDtarget",
  Value = "value",
  NodeID = "name",
  colourScale = my_color,
  LinkGroup = "group",
  NodeGroup = "group",
  fontSize = 16,
  fontFamily = 34,
  nodeWidth = 100,
  nodePadding = 20,
  height = 400,
  width = 1100,
  iterations = 32,
  sinksRight = FALSE
)

# Print the Sankey diagram
SankeyDiagram
```



## General GAM model {.tabset .tabset-fade .tabset-pills}

### Odds Ratios for Hospital Admission

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

coef_data_hosp <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/general_model_OR_hosp.rds") %>% 
  filter(
    !predictor %in% c(
      "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
      "α-Δ transition period", "Period of α predominance"
    )
  )

# Set up the forest plot using ggplot2
ggplot(coef_data_hosp, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor",
    y = "",
    title = "Odds Ratios and Confidence Intervals\nfor Hospital Admission-Associated Factors"
  ) +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  scale_x_continuous(limits = c(0, 5)) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top"
  )

rownames(coef_data_hosp) <- NULL

coef_data_hosp %>%
  arrange(rev(predictor)) %>% 
  select(
    "Hospital admission-associated factors" = predictor,
    "Odds Ratio" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value,
    !c(adverse_protective, coef)
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for Hospital Admission-associated factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### Odds Ratios for ICU Admission

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

coef_data_icu <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/general_model_OR_icu.rds") %>% 
  filter(
    !predictor %in% c(
      "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
      "α-Δ transition period", "Period of α predominance"
    )
  )

# Set up the forest plot using ggplot2
ggplot(coef_data_icu, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor",
    y = "",
    title = "Odds Ratios and Confidence Intervals\nfor ICU Admission-Associated Factors"
  ) +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  scale_x_continuous(limits = c(0, 5)) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top"
  )

rownames(coef_data_icu) <- NULL

coef_data_icu %>%
  arrange(rev(predictor)) %>% 
  select(
    "ICU admission-associated factors" = predictor,
    "Odds Ratio" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value,
    !c(adverse_protective, coef)
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for ICU Admission-associated factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### Odds Ratios for Mortality

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

coef_data_mortality <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/general_model_OR_mortality.rds") %>% 
  filter(
    !predictor %in% c(
      "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
      "α-Δ transition period", "Period of α predominance"
    )
  )

# Set up the forest plot using ggplot2
ggplot(coef_data_mortality, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor", 
    y = "",
    title = "Odds Ratios and Confidence Intervals\nfor Mortality-Associated Factors"
  ) +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  scale_x_continuous(limits = c(0, 5)) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top"
  )

rownames(coef_data_mortality) <- NULL

coef_data_mortality %>%
  arrange(rev(predictor)) %>% 
  select(
    "Mortality admission-associated factors" = predictor,
    "Odds Ratio" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value,
    !c(adverse_protective, coef)
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for mortality-associated factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### Outcome probability by age (as a smoothed variable in the GAM model)

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

age_gam_outcomes <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/GAM_outcomes_probability_by_age.rds") %>% 
  mutate(
    outcome = case_when(
      outcome == "hosp" ~ "Hospital admission",
      outcome == "icu" ~ "ICU admission",
      outcome == "mortality" ~ "Mortality"
    )
  )

ggplot(age_gam_outcomes, aes(x = x, y = fit_chance)) +
  geom_ribbon(aes(ymin = lower_bound_chance, ymax = upper_bound_chance, fill = outcome), alpha = 0.3) +
  geom_line(aes(colour = outcome)) +
  facet_wrap(facets = vars(outcome), ncol = 1) + 
  labs(
    x = "Age (years)", 
    y = "Outcome probability (%)", 
    title = "PREGUNTAR A MIGUEL ÁNGEL SOBRE ESTE CÁLCULO"
  ) +
  scale_x_continuous(breaks = c(20, 40, 60, 80, 100), limits = c(12, 105)) +
  ylim(0, 100) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "italic"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.6),
    legend.position = "none"
  )

```



## Variants distribution in Spain {.tabset .tabset-fade .tabset-pills}

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

ecdc_variants_history <- 
  import("https://opendata.ecdc.europa.eu/covid19/virusvariant/csv/data.csv") %>% 
  filter(source == "GISAID" & country == "Spain")

ecdc_all_variants <- ecdc_variants_history %>% 
  pull(variant) %>% 
  unique(.)

countA <- ecdc_variants_history %>% 
  count(variant, name = "count") %>% 
  slice_head(n = ceiling(nrow(.)/2))

countB <- ecdc_variants_history %>% 
  count(variant, name = "count") %>% 
  slice_tail(n = floor(nrow(.)/2))

table_variants_spain <- kable(list(countA, countB)) %>% kable_styling()



variants_who_labels <- 
  tribble(
    ~who_label_family, ~lineage_and_additional_mutations,
    "Omicron", "BA.2.75",
    "Omicron", "BQ.1",
    "Omicron", "XBB",
    "Omicron", "XBB.1.5",
    "Omicron", "CH.1.1",
    "Omicron", "XBB.1.16",
    "Omicron", "FE.1",
    "Alpha", "B.1.1.7",
    "Alpha", "B.1.1.7+E484K",
    "Epsilon", "B.1.427/B.1.429",
    "Unnamed", "B.1.616",
    "Eta", "B.1.525",
    "Theta", "P.3",
    "Kappa", "B.1.617.1",
    "Unnamed", "B.1.620",
    "Unnamed", "B.1.617.3",
    "Unnamed", "B.1.214.2",
    "Unnamed", "A.23.1+E484K",
    "Unnamed", "A.27",
    "Unnamed", "A.28",
    "Unnamed", "C.16",
    "Beta", "B.1.351+P384L",
    "Beta", "B.1.351+E516Q",
    "Alpha", "B.1.1.7+L452R",
    "Alpha", "B.1.1.7+S494P",
    "Iota", "B.1.526",
    "Unnamed", "B.1.526.1",
    "Unnamed", "B.1.526.2",
    "Zeta", "P.2",
    "Unnamed", "B.1.1.519",
    "Unnamed", "AV.1",
    "Unnamed", "AT.1",
    "Unnamed", "C.36+L452R",
    "Gamma", "P.1+P681H",
    "Mu", "B.1.621",
    "Lambda", "C.37",
    "Unnamed", "AY.4.2",
    "Unnamed", "B.1.1.318",
    "Delta", "B.1.617.2",
    "Unnamed", "C.1.2",
    "Delta", "B.1.617.2",
    "Delta", "B.1.617.2",
    "Delta", "B.1.617.2",
    "Beta", "B.1.351",
    "Gamma", "P.1",
    "Unnamed", "B.1.640",
    "Unnamed", "XF",
    "Unnamed", "XD",
    "Delta", "B.1.617.2",
    "Omicron", "BA.1",
    "Omicron", "BA.3",
    "Omicron", "BA.2 + L452X",
    "Omicron", "XAK",
    "Omicron", "B.1.1.529 + R346X",
    "Omicron", "B.1.1.529 + K444X, N460X",
    "Omicron", "B.1.1.529 + N460X, F490X",
    "Omicron", "BA.2.3.20",
    "Omicron", "BF.7",
    "Omicron", "BA.2",
    "Omicron", "BA.4",
    "Omicron", "BA.5",
    "Omicron", "XBC",
    "Omicron", "BN.1",
    "Omicron", "XAY"
  ) %>% 
  mutate(
    lineage_and_additional_mutations = if_else(
      who_label_family == "Unnamed", "Unknown", lineage_and_additional_mutations
    )
  ) %>% 
  distinct()



variants_week_spain_labels <- ecdc_variants_history %>% 
  select(-c(country, country_code, source, valid_denominator)) %>%
  mutate(variant = if_else(variant %in% c("Other", "UNK"), "Unknown", variant)) %>% 
  left_join(variants_who_labels, by = c("variant" = "lineage_and_additional_mutations")) %>% 
  mutate(
    who_label_family = case_when(
      who_label_family %in% c("Omicron", "Delta", "Alpha", "Gamma", "Beta") ~ who_label_family,
      TRUE ~ "Other variants or unnamed"
    ),
    percent_variant2 = number_detections_variant/number_sequenced*100
  ) %>% 
  filter(!is.nan(percent_variant2)) %>% 
  mutate(year_week2 = gsub("-", "", year_week)) %>% 
  filter(
    !year_week2 %in% c(
      "202006", paste0(2022, 14:52), paste0(20230, 1:9), paste0(2023, 10:52)
    )) %>% 
  select(who_label_family, percent_variant2, everything())



variants_ordered <- c("Omicron", "Delta", "Alpha", "Beta", "Gamma", "Other variants or unnamed")

variants_week_spain_labels %<>% 
  mutate(who_label_family = factor(who_label_family, levels = variants_ordered, ordered = TRUE))
  


cutpoints_variants_of_study <- variants_week_spain_labels %>% 
  filter(who_label_family %in% c("Alpha", "Delta", "Omicron")) %>% 
  mutate(
    year_week = gsub("-", "", year_week),
    year_week = as.numeric(year_week)
  ) %>% 
  arrange(who_label_family, year_week)



begining_alpha <- 
  ymd(20210308) # monday of isoweek 2021-10, when alpha started to account for >=75% of sequenced samples
end_alpha <- 
  ymd(20210606) # sunday of isoweek 2021-22, when alpha ended to account for >=75% of sequenced samples
begining_delta <- 
  ymd(20210712) # monday of isoweek 2021-28, when delta started to account for >=75% of sequenced samples
end_delta <- 
  ymd(20211212) # sunday of isoweek 2021-49, when delta ended to account for >=75% of sequenced samples
begining_omicron <- 
  ymd(20211227) # monday of isoweek 2021-52, when omicron started to account for >=75% of sequenced samples
end_omicron <- 
  ymd(20220331) # last day of study



variants_week_spain_labels2 <- variants_week_spain_labels %>% 
  group_by(who_label_family, year_week) %>% 
  summarise(percent_variant2 = sum(percent_variant2)) %>% 
  ungroup()
  
alpha_col <- "#CBD5E8"
delta_col <- "#FDCDAC"
omicron_col <- "#B3E2CD"

```



### Option A

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

variants_week_spain_labels2 %<>% 
  mutate(
    year_week = paste(
      substr(variants_week_spain_labels2$year_week, 1, 4), "-week ", 
      substr(variants_week_spain_labels2$year_week, 6, 7), sep = ""
    )
  )

axis_weeks <- 
  variants_week_spain_labels2$year_week[seq(1, length(variants_week_spain_labels2$year_week), by = 2)]



variants_week_spain_labels2 %>% 
  ggplot() +
  geom_rect(
    xmin = "2021-week 10", xmax = "2021-week 22",
    ymin = -1, ymax = 101,
    fill = alpha_col, colour = NA, alpha = 0.2
  ) +
  geom_text(
    x = "2021-week 16",
    y = 50,
    label = "Time period with Alpha present\nin >75% of sequenced samples",
    size = 3,
    angle = 90,
    colour = "#5e85d1"
  ) +
  geom_rect(
    xmin = "2021-week 28", xmax = "2021-week 49",
    ymin = -1, ymax = 101,
    fill = delta_col, colour = NA, alpha = 0.2
  ) +
  geom_text(
    x = "2021-week 39",
    y = 50,
    label = "Time period with Delta present\nin >75% of sequenced samples",
    size = 3,
    angle = 90,
    colour = "#e4752a"
  ) +
  geom_rect(
    xmin = "2021-week 52", xmax = "2022-week 13",
    ymin = -1, ymax = 101,
    fill = omicron_col, colour = NA, alpha = 0.2
  ) +
  geom_text(
    x = "2022-week 06",
    y = 50,
    label = "Time period with Omicron present\nin >75% of sequenced samples",
    size = 3,
    angle = 90,
    colour = "#149f61"
  ) +
  geom_line(
    mapping = aes(x = year_week, y = percent_variant2, group = who_label_family, colour = who_label_family),
    size = 1.5,
    alpha = 1
  ) +
  scale_y_continuous(expand = expansion(add = c(1, 1))) +
  scale_x_discrete(breaks = axis_weeks) +
  scale_colour_manual(values = rev(c("#FFD92F", "#A6D854", "#E78AC3", "#8DA0CB", "#FC8D62", "#66C2A5"))) +
  theme_minimal() + 
  theme(
    axis.ticks = element_line(size = 0.5, colour = "black"),
    axis.ticks.length = unit(1, "mm"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.6),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(angle = 90, size = 4, hjust = 0, vjust = 0.5),
    legend.title = element_blank()
  ) +
  labs(
    x = NULL,
    y = "Percentage over total sequenced samples",
    title = "Weekly proportion of SARS-CoV-2 variants sequenced in Spain",
    caption = "Source: GISAID, ECDC"
  )

```



### Option B

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

variants_week_spain_labels %<>% 
  mutate(
    year_week = paste(
      substr(variants_week_spain_labels$year_week, 1, 4), "-week ", 
      substr(variants_week_spain_labels$year_week, 6, 7), sep = ""
    )
  )

axis_weeks_pre <- 
  unique(variants_week_spain_labels$year_week)[
    seq(1, length(unique(variants_week_spain_labels$year_week)), by = 2)
  ]



ggplot() +
  geom_col(
    data = variants_week_spain_labels ,
    mapping = aes(x = year_week, y = percent_variant2, fill = who_label_family),
    colour = NA,
    width = 1,
    alpha = 0.7
  ) +
  # Alpha variant label and line
  # geom_vline(xintercept = "2021-week 10", colour = "#5e85d1", size = 0.5, linetype = "solid") +
  # geom_vline(xintercept = "2021-week 22", colour = "#5e85d1", size = 0.5, linetype = "solid") +
  geom_rect(
    aes(xmin = "2021-week 10", xmax = "2021-week 22", ymin = 0, ymax = 100),
    fill = "#5e85d1", colour = NA, alpha = 0.3
  ) +
  geom_text(
    data = variants_week_spain_labels,
    x = "2021-week 16", y = 50, label = "Alpha variant in at least\n75% of sequenced samples",
    size = 3, colour = "#5e85d1", angle = 90, vjust = 0.5, hjust = 0.5
  ) +
  # Delta variant label and line
  # geom_vline(xintercept = "2021-week 28", colour = "#e4752a", size = 0.5, linetype = "solid") +
  # geom_vline(xintercept = "2021-week 49", colour = "#e4752a", size = 0.5, linetype = "solid") +
  geom_rect(
    aes(xmin = "2021-week 28", xmax = "2021-week 49", ymin = 0, ymax = 100),
    fill = "#e4752a", colour = NA, alpha = 0.3
  ) +
  geom_text(
    data = variants_week_spain_labels,
    x = "2021-week 39", y = 50, label = "Delta variant in at least\n75% of sequenced samples",
    size = 3, colour = "#e4752a", angle = 90, vjust = 0.5, hjust = 0.5
  ) +
  # Omicron variant label and line
  # geom_vline(xintercept = "2021-week 52", colour = "#149f61", size = 0.5, linetype = "solid") +
  # geom_vline(xintercept = "2022-week 13", colour = "#149f61", size = 0.5, linetype = "solid") +
  geom_rect(
    aes(xmin = "2021-week 52", xmax = "2022-week 13", ymin = 0, ymax = 100),
    fill = "#149f61", colour = NA, alpha = 0.3
  ) +
  geom_text(
    data = variants_week_spain_labels,
    x = "2022-week 06", y = 50, label = "Omicron variant in at least\n75% of sequenced samples",
    size = 3, colour = "#149f61", angle = 90, vjust = 0.5, hjust = 0.5
  ) +
  scale_y_continuous(expand = expansion(add = c(0, 0))) +
  scale_x_discrete(breaks = axis_weeks_pre, expand = expansion(add = c(days(0), days(14)))) +
  scale_fill_manual(values = rev(c("#FFD92F", "#A6D854", "#E78AC3", "#8DA0CB", "#FC8D62", "#66C2A5"))) +
  # scale_fill_brewer(palette = "Set3") +
  theme_bw() +
  theme(
    axis.ticks = element_line(size = 0.5, colour = "black"),
    axis.ticks.length = unit(1, "mm"),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(angle = 90, size = 4, hjust = 1, vjust = 0.5),
    legend.title = element_blank()
  ) +
  labs(
    x = "Epi week",
    y = "Variants percent",
    title = "Weekly proportion of SARS-CoV-2 variants sequenced in Spain",
    caption = "Source: GISAID, ECDC"
  )



# ggsave(
#   filename = "/opt/datos_compartidos/vacunas_data/figuras/variants_spain.png",
#   device = "png",
#   width = 8000,
#   height = 8000,
#   dpi = 700,
#   units = "px"
# )

```



## Comparative analysis before-after vaccination campaigns {.tabset .tabset-fade .tabset-pills}

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

hosp_or_beforeafter <- 
  readRDS("/opt/datos_compartidos/vacunas_data/tablas/before vaccines VS after 75% coverage/OR_hosp.rds") %>% 
  filter(!predictor %in% c(
    "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
    "α-Δ transition period", "Period of α predominance"
  ))

icu_or_beforeafter <- 
  readRDS("/opt/datos_compartidos/vacunas_data/tablas/before vaccines VS after 75% coverage/OR_icu.rds") %>% 
  filter(!predictor %in% c(
    "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
    "α-Δ transition period", "Period of α predominance"
  ))

mortality_or_beforeafter <- 
  readRDS("/opt/datos_compartidos/vacunas_data/tablas/before vaccines VS after 75% coverage/OR_mortality.rds") %>% 
  filter(!predictor %in% c(
    "Period of Ό predominance", "Δ-Ό transition period", "Period of Δ predominance",
    "α-Δ transition period", "Period of α predominance"
  ))

# variable_order <- 
#   rev(c(
#     "Gender (male)", "Age (group 1: 12-30)", "Age (group 2: 31-49)", "Age (group 3: 50-68)",
#     "Age (group 4: 69-87)", "Age (group 5: 88-120)", "Asthma", "Ischemic heart disease", 
#     "Hepatic cirrhosis", "Diabetes", "Chronic Obstructive Pulmonary Disease (COPD)",
#     "Chronic Hepatic Disease (except cirrhosis)", "Hypertension", "Heart failure", "Chronic kidney disease",
#     "HIV+", "Solid organ cancer", "Haematologic cancer",
#     "Period before α predominance", "Period of α predominance", "α-Δ transition period",
#     "Period of Δ predominance", "Δ-Ό transition period", "Period of Ό predominance",
#     "Number of COVID Vaccines (1)", "Number of COVID Vaccines (2)", "Number of COVID Vaccines (3)",
#     "Number of Previous Infections (1)", "Number of Previous Infections (2)",
#     "No prior vaccination either infection", "Prior vaccination/infection 14-30 days ago",
#     "Prior vaccination/infection 31-60 days ago", "Prior vaccination/infection 61-90 days ago", 
#     "Prior vaccination/infection 91-120 days ago", "Prior vaccination/infection 121-180 days ago", 
#     "Prior vaccination/infection more than 180 days ago"
#   ))

```



### Hospital Admission, before vs after vaccines

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

ggplot(hosp_or_beforeafter, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor, shape = data_origin)) +
  geom_point(
    size = 2,
    aes(color = adverse_protective)
  ) +
  geom_errorbarh(
    height = 0.2, aes(color = adverse_protective)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor",
    y = "",
    title = "Odds Ratios and Confidence Intervals for\nHospital Admission-Associated Factors"
  ) +
  theme_minimal() +
  # scale_y_discrete(limits = rev(levels(coef_data2$predictor))) +
  scale_shape_manual(
    values = c(15, 19),
    labels = c("Cases after reaching 75% vaccine coverage", "Cases before vaccine introduction"),
    name = "Sample subset:"
  ) + 
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )



hosp_or_beforeafter %>% 
  select(-c(coef, adverse_protective)) %>% 
  pivot_wider(
    id_cols = predictor,
    names_from = data_origin,
    values_from = c(OR, OR_upper, OR_lower, p_value)
  ) %>% 
  arrange(rev(predictor)) %>% 
  select(
    "Hospital admission-associated factors" = predictor,
    "Odds Ratio (1)" = OR_before_vaccine_introduction,
    "Odds Ratio lower CI limit (1)" = OR_lower_before_vaccine_introduction,
    "Odds Ratio upper CI limit (1)" = OR_upper_before_vaccine_introduction,
    "p value (1)" = p_value_before_vaccine_introduction,
    "Odds Ratio (2)" = "OR_after_75%coverage",
    "Odds Ratio lower CI limit (2)" = "OR_lower_after_75%coverage",
    "Odds Ratio upper CI limit (2)" = "OR_upper_after_75%coverage",
    "p value (2)" = "p_value_after_75%coverage"
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for hospital admission-associated factors.\n(1) refers to the subgroup of cases ocurred prior to vaccine introduction.\n(2) refers to the subgroup of cases ocurred after 75% vaccine coverage was reached") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### ICU admission, before VS after vaccines

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

ggplot(icu_or_beforeafter, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor, shape = data_origin)) +
  geom_point(
    size = 2,
    aes(color = adverse_protective)
  ) +
  geom_errorbarh(
    height = 0.2, aes(color = adverse_protective)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor", 
    y = "",
    title = "Odds Ratios and Confidence Intervals for\nICU Admission-Associated Factors"
  ) +
  theme_minimal() +
  # scale_y_discrete(limits = rev(levels(coef_data2$predictor))) +
  scale_shape_manual(
    values = c(15, 19),
    labels = c("Cases after reaching 75% vaccine coverage", "Cases before vaccine introduction"),
    name = "Sample subset:"
  ) + 
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  scale_x_continuous(limits = c(0, 8)) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )



icu_or_beforeafter %>% 
  select(-c(coef, adverse_protective)) %>% 
  pivot_wider(
    id_cols = predictor,
    names_from = data_origin,
    values_from = c(OR, OR_upper, OR_lower, p_value)
  ) %>% 
  arrange(rev(predictor)) %>% 
  select(
    "ICU admission-associated factors" = predictor,
    "Odds Ratio (1)" = OR_before_vaccine_introduction,
    "Odds Ratio lower CI limit (1)" = OR_lower_before_vaccine_introduction,
    "Odds Ratio upper CI limit (1)" = OR_upper_before_vaccine_introduction,
    "p value (1)" = p_value_before_vaccine_introduction,
    "Odds Ratio (2)" = "OR_after_75%coverage",
    "Odds Ratio lower CI limit (2)" = "OR_lower_after_75%coverage",
    "Odds Ratio upper CI limit (2)" = "OR_upper_after_75%coverage",
    "p value (2)" = "p_value_after_75%coverage"
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for ICU admission-associated factors.\n(1) refers to the subgroup of cases ocurred prior to vaccine introduction.\n(2) refers to the subgroup of cases ocurred after 75% vaccine coverage was reached") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### 30 days-mortality, before VS after vaccines

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

ggplot(mortality_or_beforeafter, aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = predictor, shape = data_origin)) +
  geom_point(
    size = 2,
    aes(color = adverse_protective)
  ) +
  geom_errorbarh(
    height = 0.2, aes(color = adverse_protective)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Odds Ratio", 
    # y = "Predictor", 
    y = "",
    title = "Odds Ratios and Confidence Intervals for\nMortality-Associated Factors"
  ) +
  theme_minimal() +
  # scale_y_discrete(limits = rev(levels(coef_data2$predictor))) +
  scale_shape_manual(
    values = c(15, 19),
    labels = c("Cases after reaching 75% vaccine coverage", "Cases before vaccine introduction"),
    name = "Sample subset:"
  ) + 
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    # breaks = c("#c0392b", "#27ae60", "gray90"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome:"
  ) +
  scale_x_continuous(limits = c(0, 8)) +
  theme(
    # plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )



mortality_or_beforeafter %>% 
  select(-c(coef, adverse_protective)) %>% 
  pivot_wider(
    id_cols = predictor,
    names_from = data_origin,
    values_from = c(OR, OR_upper, OR_lower, p_value)
  ) %>% 
  arrange(rev(predictor)) %>% 
  select(
    "ICU admission-associated factors" = predictor,
    "Odds Ratio (1)" = OR_before_vaccine_introduction,
    "Odds Ratio lower CI limit (1)" = OR_lower_before_vaccine_introduction,
    "Odds Ratio upper CI limit (1)" = OR_upper_before_vaccine_introduction,
    "p value (1)" = p_value_before_vaccine_introduction,
    "Odds Ratio (2)" = "OR_after_75%coverage",
    "Odds Ratio lower CI limit (2)" = "OR_lower_after_75%coverage",
    "Odds Ratio upper CI limit (2)" = "OR_upper_after_75%coverage",
    "p value (2)" = "p_value_after_75%coverage"
  ) %>%
  kable(caption = "Odds Ratios and Confidence Intervals for mortality-associated factors.\n(1) refers to the subgroup of cases ocurred prior to vaccine introduction.\n(2) refers to the subgroup of cases ocurred after 75% vaccine coverage was reached") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



## Sub-analyses: {.tabset .tabset-fade .tabset-pills}

```{r, include = FALSE}

# CARGA DE DATOS
# 
# Para el/la que quiera consultar el código: el nombre de los objetos obedece a:
# 
# - en **minúscula**, los criterios para subdividir la base de datos;
# - en **mayúscula**, el outcome principal incluido en las regresiones GAM empleadas por cada subgrupo. 
# Son mutuamente excluyentes (si se incluyó el n_vacunas, se excluyó el tiempo desde inmunización y viceversa)

# ESTOS DATOS SON GENERADOS EN LOS RMD 02.

var_agegr_VACCINES <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups by variant & agegroup (logreg nvaccines only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "n_vacunas_covidUna" ~ "One",
      predictor == "n_vacunas_covidDos" ~ "Two",
      predictor == "n_vacunas_covidTres" ~ "Three"
    ),
    predictor = factor(predictor, levels = c("One", "Two", "Three"))
  ) %>%
  select(outcome, predictor, variant, agegroup, everything())



var_agegr_VACCINES2 <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups2 by variant & agegroup (logreg nvaccines only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = case_when(
      agegroup == "12-43" ~ "12-43 years old",
      agegroup == "44-74" ~ "44-74 years old",
      agegroup == "Over" ~ "More than 74 years old"
    ),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "n_vacunas_covidUna" ~ "One",
      predictor == "n_vacunas_covidDos" ~ "Two",
      predictor == "n_vacunas_covidTres" ~ "Three"
    ),
    predictor = factor(predictor, levels = c("One", "Two", "Three"))
  ) %>%
  select(outcome, predictor, variant, agegroup, everything())



# var_agegr_LASTIMMUN <-
#   leer_csv_carpeta(
#     ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups by variant & agegroup (logreg lastimmun only)"
#   ) %>%
#   bind_rows() %>%
#   mutate(
#     agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
#     agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
#     variant = str_extract(original_model, "^[^_]+"),
#     variant = if_else(variant == "Before", "Before α", variant),
#     predictor = case_when(
#       predictor == "ultima_inmun_infecc_binNone" ~ "None",
#       predictor == "ultima_inmun_infecc_bin31-60" ~ "31-60",
#       predictor == "ultima_inmun_infecc_bin61-90" ~ "61-90",
#       predictor == "ultima_inmun_infecc_bin91-120" ~ "91-120",
#       predictor == "ultima_inmun_infecc_bin121-180" ~ "121-180",
#       predictor == "ultima_inmun_infecc_bin>180" ~ ">180"
#     ),
#     predictor = factor(
#       predictor,
#       levels = c("None", "31-60", "61-90", "91-120", "121-180", ">180"))
#   ) %>%
#   filter(predictor != "None") %>% 
#   select(outcome, predictor, variant, agegroup, everything())



var_agegr_LASTIMMUN2 <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups2 by variant & agegroup (logreg lastimmun only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "ultima_inmun_infecc_bin2None" ~ "None",
      predictor == "ultima_inmun_infecc_bin231-90" ~ "31-90",
      predictor == "ultima_inmun_infecc_bin291-180" ~ "91-180",
      predictor == "ultima_inmun_infecc_bin2>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>%
  select(outcome, predictor, variant, agegroup, everything())
  


var_agegr_LASTIMMUN3 <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups3 by variant & agegroup (logreg lastimmun only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = case_when(
      agegroup == "12-43" ~ "12-43 years old",
      agegroup == "44-74" ~ "44-74 years old",
      agegroup == "over" ~ "More than 74 years old"
    ),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "ultima_inmun_infecc_bin2None" ~ "None",
      predictor == "ultima_inmun_infecc_bin231-90" ~ "31-90",
      predictor == "ultima_inmun_infecc_bin291-180" ~ "91-180",
      predictor == "ultima_inmun_infecc_bin2>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, variant, agegroup, everything())



var_agegr_LASTVAC <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups2 by variant & agegroup (logreg lastvac only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "ultima_vac_infecc_binNone" ~ "None",
      predictor == "ultima_vac_infecc_bin31-90" ~ "31-90",
      predictor == "ultima_vac_infecc_bin91-180" ~ "91-180",
      predictor == "ultima_vac_infecc_bin>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, variant, agegroup, everything())



var_agegr_LASTVAC2 <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups3 by variant & agegroup (logreg lastvac only)"
  ) %>%
  bind_rows() %>%
  mutate(
    agegroup = str_extract(original_model, "(?<=_)[^_]+$"),
    agegroup = case_when(
      agegroup == "12-43" ~ "12-43 years old",
      agegroup == "44-74" ~ "44-74 years old",
      agegroup == "Over" ~ "More than 74 years old"
    ),
    variant = str_extract(original_model, "^[^_]+"),
    variant = if_else(variant == "Before", "Before α", variant),
    predictor = case_when(
      predictor == "ultima_vac_infecc_binNone" ~ "None",
      predictor == "ultima_vac_infecc_bin31-90" ~ "31-90",
      predictor == "ultima_vac_infecc_bin91-180" ~ "91-180",
      predictor == "ultima_vac_infecc_bin>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, variant, agegroup, everything())



vacc_agegr_LASTIMMUN <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups2 by nvaccines & agegroup (logreg lastimmun only)"
  ) %>%
  bind_rows() %>%
  mutate(
    nvaccine = str_extract(original_model, "(?<=_)[^_]+$"),
    nvaccine = case_when(
      nvaccine == "Ninguna" ~ "None", 
      nvaccine == "Una" ~ "1 dose", 
      nvaccine == "Dos" ~ "2 doses", 
      nvaccine == "Tres" ~ "3 doses"
    ),
    nvaccine = factor(nvaccine, levels = c("None", "1 dose", "2 doses", "3 doses")),
    agegroup = str_extract(original_model, "^[^_]+"),
    agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
    predictor = case_when(
      predictor == "ultima_inmun_infecc_bin2None" ~ "None",
      predictor == "ultima_inmun_infecc_bin231-90" ~ "31-90",
      predictor == "ultima_inmun_infecc_bin291-180" ~ "91-180",
      predictor == "ultima_inmun_infecc_bin2>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, nvaccine, agegroup, everything())



vacc_agegr_LASTVAC <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups by nvaccines & agegroup (logreg lastvac only)"
  ) %>%
  bind_rows() %>%
  mutate(
    nvaccine = str_extract(original_model, "(?<=_)[^_]+$"),
    nvaccine = case_when(
      nvaccine == "Ninguna" ~ "None", 
      nvaccine == "Una" ~ "1 dose", 
      nvaccine == "Dos" ~ "2 doses", 
      nvaccine == "Tres" ~ "3 doses"
    ),
    nvaccine = factor(nvaccine, levels = c("None", "1 dose", "2 doses", "3 doses")),
    agegroup = str_extract(original_model, "^[^_]+"),
    agegroup = if_else(agegroup == "60", "60 years or older", "59 years or younger"),
    predictor = case_when(
      predictor == "ultima_vac_infecc_binNone" ~ "None",
      predictor == "ultima_vac_infecc_bin31-90" ~ "31-90",
      predictor == "ultima_vac_infecc_bin91-180" ~ "91-180",
      predictor == "ultima_vac_infecc_bin>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, nvaccine, agegroup, everything())



vacc_agegr_LASTVAC2 <-
  leer_csv_carpeta(
    ruta = "/opt/datos_compartidos/vacunas_data/tablas/groups2 by nvaccines & agegroup (logreg lastvac only)"
  ) %>%
  bind_rows() %>%
  mutate(
    nvaccine = str_extract(original_model, "(?<=_)[^_]+$"),
    nvaccine = case_when(
      nvaccine == "Ninguna" ~ "None", 
      nvaccine == "Una" ~ "1 dose", 
      nvaccine == "Dos" ~ "2 doses", 
      nvaccine == "Tres" ~ "3 doses"
    ),
    nvaccine = factor(nvaccine, levels = c("None", "1 dose", "2 doses", "3 doses")),
    agegroup = str_extract(original_model, "^[^_]+"),
    agegroup = case_when(
      agegroup == "12-43" ~ "12-43 years old",
      agegroup == "44-74" ~ "44-74 years old",
      agegroup == "Over" ~ "More than 74 years old"
    ),
    predictor = case_when(
      predictor == "ultima_vac_infecc_binNone" ~ "None",
      predictor == "ultima_vac_infecc_bin31-90" ~ "31-90",
      predictor == "ultima_vac_infecc_bin91-180" ~ "91-180",
      predictor == "ultima_vac_infecc_bin>180" ~ ">180"
    ),
    predictor = factor(
      predictor,
      levels = c("None", "31-90", "91-180", ">180"))
  ) %>%
  filter(predictor != "None") %>% 
  select(outcome, predictor, nvaccine, agegroup, everything())

```



### A2agegroups: **Vaccine effectiveness** by number of **vaccine DOSES** (segregated by variant period and **2 age groups**) 

Groups manually excluded:

- Cases before alpha rise, 60 years old or above, with more than one vaccine dose.
- All cases before alpha rise, younger than 60 years.
- Cases during alpha predominance, 60 years old or above, with three vaccine doses.
- All cases during alpha predominance, younger than 60 years.
- Cases during delta predominance, younger than 60 years, with three vaccine doses.

Groups automatically excluded:

- Those with upper vaccine effectiveness estimation interval above 100%.
- Those with lower vaccine effectiveness estimation interval below 0%.
- Those with vaccine effectiveness point-estimate above 100% or below 0%.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

# INITIAL FILTERS WERE INSERTED MANUALLY AFTER DISCUSSION BETWEEN MAIN AUTHORS

var_agegr_VACCINES_adapted <- var_agegr_VACCINES %>% 
  filter(
    (original_model == "Before_60" & predictor == "One")
    | (original_model == "α_60" & predictor %in% c("One", "Two"))
    | (original_model == "Δ_Menor" & predictor %in% c("One", "Two"))
    | (original_model == "Δ_60" & predictor %in% c("One", "Two", "Three"))
    | original_model %in% c("Ό_60", "Ό_Menor")
  ) %>% 
  filter(veffec_lower > 0 & veffec_lower <= 100) %>% 
  filter(veffec_upper > 0 & veffec_upper <= 100) %>%
  filter(veffec > 0 & veffec < 100)



var_agegr_VACCINES_adapted %>% 
  filter(outcome == "hospitalisation") %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, nrow = 2, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing hospital admission. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_VACCINES_adapted %>% 
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, nrow = 2, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing ICU admission. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_VACCINES_adapted %>%
  filter(outcome == "mortality") %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, nrow = 2, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing mortality. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### A3agegroups: **Vaccine effectiveness** by number of **vaccine DOSES** (segregated by variant period and **3 age groups**) 

Groups manually excluded:

- Cases before alpha rise, 43 years old or above, with more than one vaccine dose.
- All cases before alpha rise, younger than 44 years.
- Cases during alpha predominance, 43 years old or above, with three vaccine doses.
- All cases during alpha predominance, younger than 44 years.
- Cases during delta predominance, younger than 44 years, with three vaccine doses.

Groups automatically excluded:

- Those with upper vaccine effectiveness estimation interval above 100%.
- Those with lower vaccine effectiveness estimation interval below 0%.
- Those with vaccine effectiveness point-estimate above 100% or below 0%.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

# INITIAL FILTERS WERE INSERTED MANUALLY AFTER DISCUSSION BETWEEN MAIN AUTHORS

var_agegr_VACCINES2_adapted <- var_agegr_VACCINES2 %>% 
  filter(
    (original_model %in% c("Before_44-74", "Before_Over") & predictor == "One")
    | (original_model %in% c("α_44-74", "α_Over") & predictor %in% c("One", "Two"))
    | (original_model == "Δ_12-43" & predictor %in% c("One", "Two"))
    | (original_model %in% c("Before_44-74", "Before_Over") & predictor %in% c("One", "Two", "Three"))
    | original_model %in% c("Ό_12-43", "Ό_44-74", "Ό_Over")
  ) %>% 
  filter(veffec_lower > 0 & veffec_lower <= 100) %>% 
  filter(veffec_upper > 0 & veffec_upper <= 100) %>%
  filter(veffec > 0 & veffec < 100)



var_agegr_VACCINES2_adapted %>% 
  filter(outcome == "hospitalisation") %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, ncol = 1, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing hospital admission by number of vaccine doses. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_VACCINES2_adapted %>% 
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, ncol = 1, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES2_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing ICU admission by number of vaccine doses. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_VACCINES2_adapted %>%
  filter(outcome == "mortality") %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = veffec_lower, ymax = veffec_upper, colour = variant),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = veffec, colour = variant), size = 3) +
  facet_wrap(~agegroup, ncol = 1, strip.position = "right") +
  scale_colour_manual(values = colours_variants) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    y = "Vaccine effectiveness",
    x = "Vaccine doses",
    colour = "Variant period",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_VACCINES2_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor %in% c("Two", "Three"),
      paste0(predictor, " doses"),
      paste0(predictor, " dose")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Vaccine doses" = predictor,
    "VE" = veffec,
    "VE lower CI limit" = veffec_lower,
    "VE upper CI limit" = veffec_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Vaccine effectiveness for preventing mortality by number of vaccine doses. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### B2agegroups: **Risk of infection** by time since **last EXPOSURE** (segregated by variant period and **2 age groups**)

Groups manually excluded:

- All cases before alpha rise, younger than 60 years.
- All cases during alpha predominance, younger than 60 years.

Groups automatically excluded:

- Those with OR point-estimate above 10.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

var_agegr_LASTIMMUN2_adapted <- var_agegr_LASTIMMUN2 %>% 
  filter(
    (original_model == "Before_60")
    | (original_model == "α_60")
    | original_model %in% c("Δ_Menor", "Δ_60")
    | original_model %in% c("Ό_Menor", "Ό_60")
  ) %>%
  filter(OR_upper < 10)



var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.7
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "mortality") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN2_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### B3agegroups: **Risk of infection** by time since **last EXPOSURE** (segregated by variant period and **3 age groups**)

Groups manually excluded:

- All cases before alpha rise, younger than 44 years.
- All cases during alpha predominance, younger than 44 years.

Groups automatically excluded:

- Those with OR point-estimate above 10.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

var_agegr_LASTIMMUN3_adapted <- var_agegr_LASTIMMUN3 %>% 
  filter(
    (original_model == "Before_44-74")
    | (original_model == "Before_over")
    | (original_model == "α_44-74")
    | (original_model == "α_over")
    | original_model %in% c("Δ_12-43", "Δ_44-74", "Δ_over")
    | original_model %in% c("Ό_12-43", "Ό_44-74", "Ό_over")
  ) %>%
  filter(OR_upper < 10)



var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.7
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "mortality") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.2
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTIMMUN3_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last exposure. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### C2agegroups: **Risk of infection** by time since **last VACCINATION** (segregated by variant period and **2 age groups**)

Groups manually excluded:

- All cases before alpha rise, younger than 60 years.
- All cases during alpha predominance, younger than 60 years.

Groups automatically excluded:

- Those with infinite OR upper CI limits.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

var_agegr_LASTVAC_adapted <- var_agegr_LASTVAC %>% 
  filter(
    (original_model == "Before_60")
    | (original_model == "α_60")
    | original_model %in% c("Δ_Menor", "Δ_60")
    | original_model %in% c("Ό_Menor", "Ό_60")
  ) %>%
  filter(!is.infinite(OR_upper))



var_agegr_LASTVAC_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC_adapted %>%
  filter(outcome == "hospitalisation") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTVAC_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC_adapted %>%
  filter(outcome == "intensivecare") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTVAC_adapted %>%
  filter(outcome == "mortality") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC_adapted %>%
  filter(outcome == "mortality") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### C3agegroups: **Risk of infection** by time since **last VACCINATION** (segregated by variant period and **3 age groups**)

Groups manually excluded:

- All cases before alpha rise, younger than 44 years.
- All cases during alpha predominance, younger than 44 years.

Groups automatically excluded:

- Those with infinite OR upper CI limits.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

var_agegr_LASTVAC2_adapted <- var_agegr_LASTVAC2 %>% 
  filter(
    (original_model == "Before_44-74")
    | (original_model == "Before_Over")
    | (original_model == "α_44-74")
    | (original_model == "α_Over")
    | original_model %in% c("Δ_12-43", "Δ_44-74", "Δ_Over")
    | original_model %in% c("Ό_12-43", "Ό_44-74", "Ό_Over")
  ) %>%
  filter(!is.infinite(OR_upper))



var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "intensivecare") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "mortality") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
    # TODO corregir este ancho de barra para que se vea aunque se pisen los limites con los puntos!!
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~variant, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 10.1)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

var_agegr_LASTVAC2_adapted %>%
  filter(outcome == "mortality") %>%
  # mutate(
  #   predictor = if_else(
  #     predictor == "None",
  #     predictor,
  #     paste0(predictor, " days")
  #   )
  # ) %>%
  select(
    "Variant period" = variant,
    "Age group" = agegroup,
    "Time past since last vaccine dose (days)" = predictor,
    "Odds Ratio (OR)" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last vaccine dose. Data stratification by variant period and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### D2agegroups: **Risk of infection** by time since **last EXPOSURE** (segregated by number of vaccine doses and **2 age groups**)

Groups automatically excluded:

- Those with infinite OR upper CI limit.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

vacc_agegr_LASTIMMUN_adapted <- vacc_agegr_LASTIMMUN %>% 
  # filter(
  #   (original_model == "Before_60")
  #   | (original_model == "α_60")
  #   | (original_model == "Δ_Menor")
  #   | (original_model == "Δ_60")
  #   | original_model %in% c("Ό_60", "Ό_Menor")
  # ) %>%
  filter(!is.infinite(OR_upper))



vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  # TODO el squish!!!!!! explicar qué pasa con ese borde
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last exposure. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last exposure. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "mortality") %>%
  filter(OR_upper < 20) %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last exposure",
    colour = "Age group",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTIMMUN_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last exposure. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

### E2agegroups: **Risk of infection** by time since **last VACCINATION** (segregated by number of vaccine doses and **2 age groups**)

Groups automatically excluded:

- Those with infinite OR upper CI limit.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

vacc_agegr_LASTVAC_adapted <- vacc_agegr_LASTVAC %>% 
  # filter(
  #   (original_model == "Before_60")
  #   | (original_model == "α_60")
  #   | (original_model == "Δ_Menor")
  #   | (original_model == "Δ_60")
  #   | original_model %in% c("Ό_60", "Ό_Menor")
  # ) %>%
  filter(!is.infinite(OR_upper))



vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  # TODO el squish!!!!!! explicar qué pasa con ese borde
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "mortality") %>%
  filter(OR_upper < 20) %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



### E3agegroups: **Risk of infection** by time since **last VACCINATION** (segregated by number of vaccine doses and **3 age groups**)

Groups automatically excluded:

- Those with infinite OR upper CI limit.

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

vacc_agegr_LASTVAC2_adapted <- vacc_agegr_LASTVAC2 %>% 
  # filter(
  #   (original_model == "Before_60")
  #   | (original_model == "α_60")
  #   | (original_model == "Δ_Menor")
  #   | (original_model == "Δ_60")
  #   | original_model %in% c("Ό_60", "Ό_Menor")
  # ) %>%
  filter(!is.infinite(OR_upper))



vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  # TODO el squish!!!!!! explicar qué pasa con ese borde
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: hospital admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "hospitalisation") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for hospital admission by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "intensivecare") %>%
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: ICU admission"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "intensivecare") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for ICU admission by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "mortality") %>%
  filter(OR_upper < 20) %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = agegroup),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = agegroup), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~nvaccine, nrow = 4, strip.position = "right") +
  scale_colour_manual(values = colours_3agegroups) +
  scale_y_continuous(limits = c(0, 6)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = "Time past since last vaccine dose",
    colour = "Age group",
    title = "Outcome: 30-days mortality"
  ) +
  theme_minimal() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "right",
    legend.box = "horizontal",
    legend.direction = "vertical"
  )

vacc_agegr_LASTVAC2_adapted %>%
  filter(outcome == "mortality") %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    "Number of vaccine doses" = nvaccine,
    "Age group" = agegroup,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for mortality by time since last vaccine dose. Data stratification by number of vaccine doses and age group") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



## General analysis of the **infection risk** by time since **last VACCINATION**

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

data <- 
  read.csv2(
    "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastvac/OR_hospitalisation_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
    sep = ","
  ) %>% 
  mutate(outcome = "Hospital admission") %>% 
  bind_rows(
    read.csv2(
      "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastvac/OR_icu_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
      sep = ","
    )
  ) %>% 
  mutate(outcome = if_else(is.na(outcome), "ICU admission", outcome)) %>% 
  bind_rows(
    read.csv2(
      "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastvac/OR_mortality_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
      sep = ","
    )
  ) %>% 
  mutate(
    outcome = if_else(is.na(outcome), "30-day mortality", outcome),
    across(coef:p_value, as.character),
    across(coef:p_value, as.numeric),
    outcome = factor(outcome, levels = c("Hospital admission", "ICU admission", "30-day mortality"))
  ) %>% 
  filter(str_detect(predictor, "Last vaccine"))



data %>%
  # filter(outcome == "hospital admission") %>%
  # filter(OR_upper < 20) %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = outcome),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = outcome), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~outcome, nrow = 4, strip.position = "top") +
  # scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 6)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = NULL,
    colour = "Age group",
    title = "Infection risk (OR) by time since last vaccination"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "italic"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    # strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "none"
    # legend.box = "horizontal",
    # legend.direction = "vertical"
  )



data %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    # "Number of vaccine doses" = nvaccine,
    # "Age group" = agegroup,
    "Outcome of interest" = outcome,
    "Time past since last vaccine dose" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for the outcomes of interest by time since last vaccine dose.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```



## General analysis of the **infection risk** by time since **last EXPOSURE**

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "100%"}

data <- 
  read.csv2(
    "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastimmun/OR_hospitalisation_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
    sep = ","
  ) %>% 
  mutate(outcome = "Hospital admission") %>% 
  bind_rows(
    read.csv2(
      "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastimmun/OR_icu_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
      sep = ","
    )
  ) %>% 
  mutate(outcome = if_else(is.na(outcome), "ICU admission", outcome)) %>% 
  bind_rows(
    read.csv2(
      "/opt/datos_compartidos/vacunas_data/tablas/general by timesincelastimmun/OR_mortality_subgroups_nvacc_PREDICTORtimesincelastvac2.xls",
      sep = ","
    )
  ) %>% 
  mutate(
    outcome = if_else(is.na(outcome), "30-day mortality", outcome),
    across(coef:p_value, as.character),
    across(coef:p_value, as.numeric),
    outcome = factor(outcome, levels = c("Hospital admission", "ICU admission", "30-day mortality"))
  ) %>% 
  filter(str_detect(predictor, "Last exposed"))



data %>%
  # filter(outcome == "hospital admission") %>%
  # filter(OR_upper < 20) %>% 
  ggplot() +
  geom_errorbar(
    aes(x = predictor, ymin = OR_lower, ymax = OR_upper, colour = outcome),
    linewidth = 1,
    width = 0.5
  ) +
  geom_point(aes(x = predictor, y = OR, colour = outcome), size = 3) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  facet_wrap(~outcome, nrow = 4, strip.position = "top") +
  # scale_colour_manual(values = colours_3agegroups) +
  # scale_y_continuous(limits = c(0, 6)) +
  theme(axis.text.x = element_text(vjust = 0.5)) +
  labs(
    y = "Risk (Odds Ratio)",
    x = NULL,
    colour = "Age group",
    title = "Infection risk (OR) by time since last exposure"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "italic"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    # strip.background = element_rect(colour = "black", fill = "gray80", linewidth = 0.6),
    plot.title = element_text(hjust = 0.5),
    axis.line.x = element_line(linewidth = 0.6),
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"),
    legend.position = "none"
    # legend.box = "horizontal",
    # legend.direction = "vertical"
  )



data %>%
  mutate(
    predictor = if_else(
      predictor == "None",
      predictor,
      paste0(predictor, " days")
    )
  ) %>%
  select(
    # "Number of vaccine doses" = nvaccine,
    # "Age group" = agegroup,
    "Outcome of interest" = outcome,
    "Time past since last exposure" = predictor,
    "OR" = OR,
    "OR lower CI limit" = OR_lower,
    "OR upper CI limit" = OR_upper,
    "p value" = p_value
  ) %>%
  kable(caption = "Risk (Odds Ratio) for the outcomes of interest by time since last exposure.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```
























# Upset Plot for describing categories

```{r cars}
# upset(data=vacunas, intersections = NOM_VACUNA,group.by = COD_NUHSA_ENCRIPTADO, order.by = "freq")
```








# Rentabilidad Edad

```{r}
# Definir los parámetros
# costo_hospitalizacion <- 4612.76
# precio_vacuna <- 31
# dosis_equiv <- 148
# nnt <- 148
# red_abs_riesgo <- 0.0068

# Definir un vector de edades de 18 a 120
# edades <- 18:120

# Calcular la rentabilidad para cada edad
# rentabilidad <- (costo_hospitalizacion/dosis_equiv) / nnt / (1 - red_abs_riesgo)

# Crear un dataframe con los resultados
# df <- data.frame(edad = edades, rentabilidad = rentabilidad)

```

