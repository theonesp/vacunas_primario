---
title: "03_tables_infections"
# output: html_document
---

# Environment

```{r}
library(dplyr)
library(magrittr)
library(tableone)
library(kableExtra)
library(gtsummary)
library(rio)
library(purrr)
library(summarytools)
library(zoo)
library(lubridate)
library(vroom)
library(stringr)
library(stringi)
library(tidyr)
library(ggplot2)
library(parallel)
library(janitor)



estudio_vacunas_t_final_selected <- 
  readRDS("/opt/datos_compartidos/vacunas_data/Rfiles/estudio_vacunas_t_final_selected_manuscript.rds")
```

# Table 1

```{r}
str(estudio_vacunas_t_final_selected)



##############################################################################################################
# Description of total data

t1_total_age <- estudio_vacunas_t_final_selected %>%
  select(age) %>%
  tbl_summary(
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(age ~ 2)
  )
t1_total_age

t1_total_categ <- estudio_vacunas_t_final_selected %>%
  select(where(is.factor)) %>%
  select(-c(mortality, mortality30d, hosp_stay_bin, icu_stay_bin)) %>% 
  tbl_summary(statistic = list(all_categorical() ~ "{n} ({p}%)"))
t1_total_categ



##############################################################################################################
# Description by hospital stay

t1_byhosp_age_hosp_duration <- estudio_vacunas_t_final_selected %>%
  select(hosp_stay_bin, age, estancia_hospitalaria_dias) %>%
  tbl_summary(
    by = hosp_stay_bin,
    statistic = list(
      age ~ "{mean} ({sd})",
      estancia_hospitalaria_dias ~ "{median} ({p25}, {p75})"
    ),
    digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_byhosp_age_hosp_duration


t1_byhosp_categ <- estudio_vacunas_t_final_selected %>%
  select(where(is.factor)) %>%
  select(-c(mortality, mortality30d, icu_stay_bin)) %>% 
  tbl_summary(
    by = hosp_stay_bin,
    percent = "row",
    statistic = list(all_categorical() ~ "{n} ({p}%)")
    # digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_byhosp_categ



##############################################################################################################
# Description by ICU stay

t1_byicu_age_icu_duration <- estudio_vacunas_t_final_selected %>%
  filter(hosp_stay_bin == "Sí") %>% 
  select(icu_stay_bin, age, estancia_hospitalaria_dias, num_dias_uci) %>%
  tbl_summary(
    by = icu_stay_bin,
    statistic = list(
      age ~ "{mean} ({sd})",
      estancia_hospitalaria_dias ~ "{median} ({p25}, {p75})",
      num_dias_uci ~ "{median} ({p25}, {p75})"
    ),
    digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_byicu_age_icu_duration


t1_byicu_categ <- estudio_vacunas_t_final_selected %>%
  filter(hosp_stay_bin == "Sí") %>% 
  select(where(is.factor)) %>%
  select(-c(mortality, mortality30d, hosp_stay_bin)) %>% 
  tbl_summary(
    by = icu_stay_bin,
    percent = "row",
    statistic = list(all_categorical() ~ "{n} ({p}%)")
    # digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_byicu_categ



##############################################################################################################
# Description by mortality at 30 days

t1_bymortality_age_icu_duration <- estudio_vacunas_t_final_selected %>%
  select(mortality30d, age, estancia_hospitalaria_dias, num_dias_uci) %>%
  tbl_summary(
    by = mortality30d,
    statistic = list(
      age ~ "{mean} ({sd})",
      estancia_hospitalaria_dias ~ "{median} ({p25}, {p75})",
      num_dias_uci ~ "{median} ({p25}, {p75})"
    ),
    digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_bymortality_age_icu_duration


t1_bymortality_categ <- estudio_vacunas_t_final_selected %>%
  select(where(is.factor)) %>%
  select(-c(mortality, icu_stay_bin, hosp_stay_bin)) %>% 
  tbl_summary(
    by = mortality30d,
    percent = "row",
    statistic = list(all_categorical() ~ "{n} ({p}%)")
    # digits = list(age ~ 2)
  )
  # add_p() %>% 
  # add_ci()
t1_bymortality_categ
```


