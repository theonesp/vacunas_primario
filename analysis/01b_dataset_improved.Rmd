---
title: "01_dataset_creation_improved"
output: html_document
---

# Calling libraries

```{r}
library(data.table)
library(summarytools)
library(zoo)
library(dtplyr)
library(dplyr, warn.conflicts = FALSE)
library(magrittr)
library(lubridate)
library(vroom)
library(stringr)
library(stringi)
library(tidyr)
library(ggplot2)
library(parallel)
library(janitor)
library(purrr)
```

# Defining functions

```{r}
special_date <- function(number) {
  date <- if_else(number %in% c(-1, 0, NA), as.Date(NA), as.Date(as.character(number), format = "%Y%m%d"))
  return(date)
}

convertir_valores <- function(x) {ifelse(x == -1, 0, 1)}
```

# Data Load and Wrangling

## resultados_pruebas_COVID

```{r RESULTADOS_PRUEBAS_COVID}
# TODO pendientes de PRDA



########################################################################################################
# Loading data + selecting columns + mutating date variables.

resultados_pruebas_COVID <-
  fread(
    "/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_TEST_COVID.txt",
    header = T,
    encoding = 'UTF-8'
  ) %>% 
  as.data.frame() %>% 
  select(-TIPO_PRUEBA) %>% 
  mutate(FECHA_MUESTRA = as.Date(as.character(FECHA_MUESTRA), format = "%d/%m/%Y"))



########################################################################################################
# Getting only PCRs with available date, being positive and sampled during study period.

# TODO aplicar criterios de exclusión según orden razonado de carga de datasets!

pcr_covid <- setDT(resultados_pruebas_COVID) %>%
  lazy_dt(immutable = FALSE) %>% 
  filter(
    DESC_T_PRUEBA == "PCR" 
    & !is.na(FECHA_MUESTRA) 
    & FECHA_MUESTRA > ymd(20200229)
    & FECHA_MUESTRA < ymd(20220401) # TODO revisar esta fecha. Creo que es la máxima de las vacunas recibidas
    & RESULTADO %in% c("Positivo", "ositivo")
  ) %>% 
  group_by(NUHSA_ENCRIPTADO) %>% 
  arrange(FECHA_MUESTRA) %>% 
  mutate(n_infect = row_number()) %>% 
  ungroup() %>% 
  select(-c(DESC_T_PRUEBA, RESULTADO)) %>% 
  as.data.frame()

remove(resultados_pruebas_COVID)



########################################################################################################
# Pivoting wider to get patients. >> 
# calculating time difference between last and first PCRs, per patient.

infect_covid <- setDT(pcr_covid) %>% 
  lazy_dt() %>% 
  group_by(NUHSA_ENCRIPTADO) %>% 
  pivot_wider(names_from = n_infect, values_from = FECHA_MUESTRA) %>% 
  ungroup() %>% 
  as.data.frame()

infect_maxtimediff <- setDT(pcr_covid) %>% 
  lazy_dt(immutable = TRUE) %>% 
  group_by(NUHSA_ENCRIPTADO) %>% 
  mutate(maxtimediff = as.numeric(max(FECHA_MUESTRA) - min(FECHA_MUESTRA))) %>% 
  ungroup() %>% 
  select(NUHSA_ENCRIPTADO, maxtimediff) %>% 
  distinct() %>% 
  as.data.frame()

infect_covid2 <- setDT(infect_covid) %>% 
  lazy_dt(immutable = TRUE) %>% 
  left_join(infect_maxtimediff, by = "NUHSA_ENCRIPTADO") %>% 
  select(NUHSA_ENCRIPTADO, maxtimediff, everything()) %>% 
  as.data.frame()

remove(pcr_covid)
remove(infect_covid)
remove(infect_maxtimediff)
gc()



########################################################################################################
# Taking into account the traditional consensus that reinfections occur more frequently after...
# 90 days passed from previous infection:
##### First we subset patients with 1+ PCRs but a maximum timediff of <90 days. Kept only first PCR date.

infect_covid_oneinf <- setDT(infect_covid2) %>% 
  lazy_dt(immutable = TRUE) %>% 
  filter(maxtimediff < 90) %>% 
  select(NUHSA_ENCRIPTADO, pcr1 = `1`) %>% 
  as.data.frame()

##### For those subset with maximum timediff of >=90 days:
########## We tried to discriminate "followup" or "high cycle threshold" PCR from "true reinfection" PCRs.
########## We assessed the output considering different timediffs with prior PCR (10 days, 20d, up to 90d).
########## 50 days was the timediff with best results. Those PCRs with <50 days from previous PCR...
########## were considered "followup" or "high cycle threshold" PCR.

infect_covid_plusoneinf_raw <- setDT(infect_covid2) %>% 
  lazy_dt(immutable = TRUE) %>% 
  filter(maxtimediff > 89) %>% 
  select(-maxtimediff) %>% 
  select(2:20, NUHSA_ENCRIPTADO) %>% 
  as.data.frame()

infect_covid_plusoneinf_raw2 <- setDT(infect_covid_plusoneinf_raw) %>% 
  lazy_dt(immutable = FALSE) %>% 
  pivot_longer(
    1:(ncol(.) - 1),
    names_to = "orden_pcr",
    values_to = "fecha_pcr"
  ) %>% 
  mutate(orden_pcr = as.numeric(orden_pcr)) %>% 
  arrange(NUHSA_ENCRIPTADO, orden_pcr) %>% 
  mutate(diff = as.numeric(fecha_pcr - lag(fecha_pcr, n = 1))) %>% 
  mutate(
    diff = if_else(orden_pcr == 1, as.numeric(NA), diff),
    fecha_pcr = if_else(
      orden_pcr > 1 & (is.na(fecha_pcr) | diff < 50), as.Date(NA), fecha_pcr
    )
  ) %>% 
  select(-diff) %>% 
  arrange(NUHSA_ENCRIPTADO, fecha_pcr) %>% 
  mutate(recalc_maxtimediff = as.numeric(fecha_pcr - lag(fecha_pcr, n = 1))) %>% 
  filter(
    orden_pcr == 1
    | (!is.na(recalc_maxtimediff) & recalc_maxtimediff > 89)
  ) %>% 
  as.data.frame()

# Due to the few rows in this dataset, we performed the following operations with tidyverse only.

infect_covid_plusoneinf <- infect_covid_plusoneinf_raw2 %>% 
  group_by(NUHSA_ENCRIPTADO) %>% 
  arrange(fecha_pcr) %>% 
  mutate(orden_pcr = row_number()) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = NUHSA_ENCRIPTADO, names_from = "orden_pcr", values_from = "fecha_pcr") %>%
  rename_with(~paste0("pcr", .x), -NUHSA_ENCRIPTADO) %>% 
  select_if(~sum(is.na(.x)) < nrow(infect_covid_plusoneinf_raw))



########################################################################################################
# Joining "only one infection" with "+1 infections" patients. >>
# Pivoting longer to set the dataframe infection-wise and not infected-wise.

infect_covid3 <- infect_covid_plusoneinf %>% 
  bind_rows(infect_covid_oneinf)

infect_covid4 <- setDT(infect_covid3) %>% 
  lazy_dt(immutable = TRUE) %>% 
  rename(
    `1` = pcr1,
    `2` = pcr2,
    `3` = pcr3
  ) %>% 
  pivot_longer(cols = 2:4, names_to = "orden_infeccion", values_to = "fecha_pcr") %>% 
  mutate(orden_infeccion = as.numeric(orden_infeccion)) %>% 
  filter(!is.na(fecha_pcr)) %>% 
  arrange(NUHSA_ENCRIPTADO, fecha_pcr) %>% 
  select(NUHSA_ENCRIPTADO, orden_infeccion, infect_covid_first_date = fecha_pcr) %>% 
  as.data.frame()

remove(infect_covid2)
remove(infect_covid3)
remove(infect_covid_oneinf)
remove(infect_covid_plusoneinf_raw)
remove(infect_covid_plusoneinf_raw2)
remove(infect_covid_plusoneinf)
gc()
```

## poblacion_diana

```{r}
########################################################################################################
# Loading data, releveling sex, obtaining age at the beginning of study period and a mortality indicator.

poblacion_diana <- 
  fread(
    "/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_POB_DIANA.txt", 
    header = T, 
    encoding = 'Latin-1'
  )

poblacion_diana2 <- setDT(poblacion_diana) %>% 
  lazy_dt(immutable = TRUE) %>% 
  mutate(
    COD_FEC_NACIMIENTO = as.character(poblacion_diana$COD_FEC_NACIMIENTO),
    DESC_SEXO = as.factor(DESC_SEXO)
  ) %>% 
  mutate(
    COD_FEC_NACIMIENTO = as.Date(COD_FEC_NACIMIENTO, format = "%Y%m%d"),
    DESC_SEXO = relevel(DESC_SEXO, ref = "Mujer")
  ) %>% 
  mutate(age = days(ymd(20200301) - COD_FEC_NACIMIENTO) / years(1)) %>% 
  mutate(
    age = trunc(age),
    mortality = convertir_valores(FEC_FALLECIMIENTO)
  ) %>% 
  as.data.frame()

remove(poblacion_diana)
gc()
```

## pupa (Periodo-Usuario-PAtologías)

```{r}
########################################################################################################
# Loading data and removing duplicates.
pupa <- 
  fread(
    "/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_PUPA.txt", header = T, encoding = 'Latin-1'
  ) %>% 
  as.data.frame() 

pupa %<>% distinct()



########################################################################################################
# Converting date variables; -1 == comorbidity was still active at the time of extraction. >>
# Transforming character variables to get rid of capital letters and accents.

pupa <- setDT(pupa) %>% 
  lazy_dt(immutable = FALSE) %>% 
  mutate(
    COD_FEC_INI_PATOLOGIA = as.Date(as.character(COD_FEC_INI_PATOLOGIA), format="%Y%m%d"),
    COD_FEC_FIN_PATOLOGIA = special_date(COD_FEC_FIN_PATOLOGIA),
    DESC_PATOLOGIA_CRONICA = tolower(make.names(stri_trans_general(DESC_PATOLOGIA_CRONICA, "latin-ascii")))
  ) %>% 
  as.data.frame()

# TODO FILTER by admission or infection date? IT IS INTENDED TO BE DONE BY INFECTION DATE



########################################################################################################
# Pooling comorbidities by healing possibilities. >>
# Purging repeated comorbidities. Many comorbidities were inserted by physicians in their daily...
# activity. For some comorbs, we consider that lasting less than a specified time lapse is indicative...
# of a coding error, attempted to be fixed later.

curable_comorb <- c(
  "asma", "diabetes", "hipertension", "cancer.de.mama", "cancer.de.tiroides",
  "melanoma.de.piel", "linfoma.no.hodgkin", "leucemia", "enfermedad.de.hodgkin",
  "cancer.de.bronquio.y.pulmon", "cancer.de.prostata", "cancer.de.testiculo", "cancer.de.vejiga",
  "cancer.de.pancreas", "cancer.de.rinon.y.pelvis.renal", "cancer.colorrectal", "cancer.de.estomago",
  "cancer.de.cabeza.y.cuello", "cancer.de.higado.y.vias.biliares", "cancer.de.hueso.y.tejidos.blandos",
  "cancer.de.cuello.uterino", "cancer.de.utero", "cancer.de.ovario", "cancer.inmunoproliferativo",
  "sarcoma.de.kaposi"
)

incurable_comorb <- c(
  "cardiopatia.isquemica", "cirrosis.hepatica", "epoc", "hepatopatia.cronica.excepto.cirrosis",
  "insuficiencia.cardiaca", "insuficiencia.renal.cronica", "vih"
)

pupa_not_repeated <- setDT(pupa) %>% 
  lazy_dt(immutable = FALSE) %>% 
  group_by(NUHSA_ENCRIPTADO, DESC_PATOLOGIA_CRONICA) %>% 
  mutate(row_index = row_number()) %>% 
  filter(all(row_index == 1)) %>% 
  ungroup() %>% 
  as.data.table()

pupa_not_repeated_fixed <- pupa_not_repeated %>% 
  lazy_dt(immutable = FALSE) %>% 
  mutate(
    COD_FEC_FIN_PATOLOGIA = if_else(
      (DESC_PATOLOGIA_CRONICA %in% curable_comorb[1:3] & COD_FEC_FIN_PATOLOGIA - COD_FEC_INI_PATOLOGIA > 179)
      | (DESC_PATOLOGIA_CRONICA %in% curable_comorb[4:25] & COD_FEC_FIN_PATOLOGIA - COD_FEC_INI_PATOLOGIA > 1825),
      COD_FEC_FIN_PATOLOGIA,
      as.Date(NA)
    )
  ) %>%
  filter(COD_FEC_FIN_PATOLOGIA > ymd(20200229) | is.na(COD_FEC_FIN_PATOLOGIA)) %>% 
  select(-row_index) %>% 
  as.data.table()

pupa_repeated <- setDT(pupa) %>% 
  lazy_dt(immutable = FALSE) %>% 
  group_by(NUHSA_ENCRIPTADO, DESC_PATOLOGIA_CRONICA) %>% 
  mutate(row_index = row_number()) %>% 
  filter(any(row_index > 1)) %>% 
  ungroup() %>% 
  as.data.table()

pupa_repeated_fixed <- pupa_repeated %>% 
  lazy_dt(immutable = FALSE) %>% 
  mutate(
    COD_FEC_FIN_PATOLOGIA = if_else(
      (DESC_PATOLOGIA_CRONICA %in% curable_comorb[1:3] & COD_FEC_FIN_PATOLOGIA - COD_FEC_INI_PATOLOGIA > 179)
      | (DESC_PATOLOGIA_CRONICA %in% curable_comorb[4:25] & COD_FEC_FIN_PATOLOGIA - COD_FEC_INI_PATOLOGIA > 1825),
      COD_FEC_FIN_PATOLOGIA,
      as.Date(NA)
    )
  ) %>% 
  group_by(NUHSA_ENCRIPTADO, DESC_PATOLOGIA_CRONICA) %>% 
  mutate(
    COD_FEC_INI_PATOLOGIA = min(COD_FEC_INI_PATOLOGIA, na.rm = TRUE),
    COD_FEC_FIN_PATOLOGIA = if_else(
      all(is.na(COD_FEC_FIN_PATOLOGIA)),
      as.Date(NA),
      min(COD_FEC_INI_PATOLOGIA, na.rm = TRUE),
    ),
    row_index2 = row_number()
  ) %>% 
  # filter(COD_FEC_INI_PATOLOGIA == min(COD_FEC_INI_PATOLOGIA, na.rm = TRUE)) %>% 
  filter(row_index2 == 1) %>% 
  ungroup() %>% 
  filter(COD_FEC_FIN_PATOLOGIA > ymd(20200229) | is.na(COD_FEC_FIN_PATOLOGIA)) %>% 
  select(-c(row_index, row_index2)) %>% 
  as.data.table()
  
pupa_dt <- as.data.frame(pupa_not_repeated_fixed) %>% 
  bind_rows(as.data.frame(pupa_repeated_fixed)) %>% 
  as.data.table()

remove(pupa)
remove(pupa_not_repeated)
remove(pupa_not_repeated_fixed)
remove(pupa_repeated)
remove(pupa_repeated_fixed)
gc()



########################################################################################################
# Creating a data table where row = person +  start and end dates for all comorbidities.
  
pupa_pivot_fechaini <- pupa_dt %>% 
  lazy_dt() %>% 
  pivot_wider(
    id_cols = NUHSA_ENCRIPTADO,
    names_from = DESC_PATOLOGIA_CRONICA,
    values_from = COD_FEC_INI_PATOLOGIA
  ) %>% 
  rename_with(~paste0(.x, "_fechaini"), !NUHSA_ENCRIPTADO) %>%
  as.data.table()

pupa_pivot_fechafin <- pupa_dt %>% 
  lazy_dt() %>% 
  pivot_wider(
    id_cols = NUHSA_ENCRIPTADO,
    names_from = DESC_PATOLOGIA_CRONICA,
    values_from = COD_FEC_FIN_PATOLOGIA,
  ) %>% 
  rename_with(~paste0(.x, "_fechafin"), !NUHSA_ENCRIPTADO) %>% 
  as.data.table()

pupa_dates <- pupa_pivot_fechaini %>% 
  lazy_dt() %>% 
  left_join(pupa_pivot_fechafin, by = "NUHSA_ENCRIPTADO") %>% 
  as.data.frame() %>% 
  select(sort(colnames(.))) %>%
  select(NUHSA_ENCRIPTADO, everything())

remove(pupa_dt)
remove(pupa_pivot_fechafin)
remove(pupa_pivot_fechaini)
gc()
```

## periodos_pandemicos

Información extraída del "Informe COVID-19 en Andalucía durante la fase aguda de la pandemia", elaborado por el Servicio de Estadísticas Sanitarias. Consejería de Salud y Familias. Disponible en el siguiente [enlace (exige red corporativa)](https://www.ieca.junta-andalucia.es/institutodeestadisticaycartografia/badea/operaciones/consulta/anual/50147?CodOper=b3_2314&codConsulta=50147).

```{r}
periodos_pandemicos_andalucia <- 
  read.csv2("/opt/datos_compartidos/vacunas_data/05_Periodos_pandemicos.csv") %>% 
  mutate(
    nombre_periodo = factor(nombre_periodo, ordered = TRUE),
    fecha_inicio = as.Date(fecha_inicio), fecha_fin = as.Date(fecha_fin)
  )
```

## episodios_cmbd

Episodios CMBD del 03/03/2019 al 01/04/2022.

One of the first 5 admission diagnoses, should be in this list

var1	freq	descripcion
U07.1	41192	COVID-19
J18.9	11869	Neumonía, microorganismo no especificado
J12.89	3384	Otros tipos de neumonía vírica
J22	3046	Infección aguda del tracto respiratorio inferior, no especificada
J96.00	2305	Insuficiencia respiratoria aguda no especificada si con hipoxia o con hipercapnia
J96.01	2131	Insuficiencia respiratoria aguda con hipoxia
J96.02	1317	Insuficiencia respiratoria aguda con hipercapnia
J96.20	1177	Insuficiencia respiratoria aguda y crónica no especificada si con hipoxia o con hipercapnia
J90	1113	Derrame pleural, no clasificable bajo otro concepto
J47.0	1045	Bronquiectasias con infección aguda de vías respiratorias bajas
J96.21	772	Insuficiencia respiratoria aguda y crónica con hipoxia
J98.01	597	Broncoespasmo agudo
J18.0	512	Bronconeumonía, microorganismo no especificado
J84.9	497	Enfermedad intersticial pulmonar, no especificada
J96.91	365	Insuficiencia respiratoria no especificada, con hipoxia
J96.90	348	Insuficiencia respiratoria no especificada, sin especificar si con hipoxia o con hipercapnia
J96.92	339	Insuficiencia respiratoria no especificada, con hipercapnia
J84.89	330	Otros tipos de enfermedades pulmonares intersticiales especificadas
J81.0	302	Edema agudo de pulmón
I26.99	291	Otra embolia pulmonar sin cor pulmonale agudo
J06.9	204	Infección respiratoria aguda del tracto respiratorio superior, no especificada
J98.9	112	Trastorno respiratorio, no especificado
J95.89	107	Otras complicaciones y trastornos posprocedimiento de aparato respiratorio, no clasificados bajo otro concepto
J12.9	86	Neumonía vírica, no especificada
O98.52	82	Otras enfermedades virales que complican el parto
J84.111	72	Neumonía intersticial idiopática, no especificada de otro modo
O98.513	70	Otras enfermedades virales que complican el embarazo, tercer trimestre
J20.8	66	Bronquitis aguda por otros organismos especificados
J96.11	64	Insuficiencia respiratoria crónica con hipoxia
J00	62	Nasofaringitis aguda [resfriado común]
J12.81	42	Neumonía por coronavirus asociado al SARS
J84.114	42	Neumonitis intersticial aguda
J39.8	41	Otras enfermedades especificadas del tracto respiratorio superior
J84.115	15	Enfermedad pulmonar intersticial asociada a bronquiolitis respiratoria

TODO hay 92k pacientes sin fecha de ingreso. rafa: a mi ma salen todos con Fecha ingreso y alta.
TODO puede ser que ya estuvieran ingresados.

```{r}
########################################################################################################
# 
# We do not (cannot) have the date of transfer to ICU. 

icd_ofinterest <- c('U07.1', 'J18.9', 'J12.89', 'J22', 'J96.00', 'J96.01', 'J96.02', 'J96.20', 'J90', 'J47.0', 'J96.21', 'J98.01', 'J18.0', 'J84.9', 'J96.91', 'J96.90', 'J96.92', 'J84.89', 'J81.0', 'I26.99', 'J06.9', 'J98.9', 'J95.89', 'J12.9', 'O98.52', 'J84.111', 'O98.513', 'J20.8', 'J96.11', 'J00', 'J12.81', 'J84.114', 'J39.8', 'J84.115', 'J84.113')

# TODO meter los códigos que tienes apuntados y no se incluyeron en un primer momento!!





episodios_cmbd_raw <- 
  fread(
    "/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_CMBD.txt", header = T, encoding = "Latin-1"
  ) %>% 
  as.data.frame() %>% 
  select(
    -c(
      COD_D6, COD_D7, COD_D8, COD_D9, COD_D10, COD_D11, COD_D12, COD_D13, COD_D14, COD_D15, COD_D16,
      COD_D17, COD_D18, COD_D19, COD_D20,
      COD_P1, COD_P2, COD_P3, COD_P4, COD_P5, COD_P6, COD_P7, COD_P8, COD_P9, COD_P10, COD_P11, COD_P12,
      COD_P13, COD_P14, COD_P15, COD_P16, COD_P17, COD_P18, COD_P19, COD_P20
    )
  ) %>% 
  # We are only evaluating the five first diagnoses
  mutate(
    across(c(COD_FEC_INGRESO, COD_FEC_ALTA), ~as.Date(as.character(.x), format = "%Y%m%d")),
    estancia_hospitalaria_dias = as.numeric(COD_FEC_ALTA - COD_FEC_INGRESO),
    icu_stay_bin = as.factor(if_else((NUM_DIAS_UCI == 0 | is.na(NUM_DIAS_UCI)), 0, 1))
  )






# joining  the df containing infect_covid_first_date
# TODO por qué se hace este join así, y no left desde infect_covid????????

episodios_cmbd <- episodios_cmbd_raw %>% 
  left_join(infect_covid4, by = "NUHSA_ENCRIPTADO") %>% 
  mutate(
    infeccion_ingreso_dias = COD_FEC_INGRESO - infect_covid_first_date,
    infeccion_alta_dias = COD_FEC_ALTA - infect_covid_first_date,
    # dias entre infeccion e ingreso hospitalario ha de ser de 30 días máximo. 
    # si no, no lo considero ingreso hospitalario por COVID
    # los aún ingresados en el período de análisis habrían de tenerse en cuenta.
    # Es menor de 30; si sale negativo también se cuenta.
    hosp_stay_bin = if_else(infeccion_ingreso_dias <= 30 & infeccion_alta_dias >= 0 , 1, 0)
  ) %>% 
  select(NUHSA_ENCRIPTADO, orden_infeccion, infect_covid_first_date, everything())




  
# episodios_cmbd %>%
#   # arrange(infeccion_alta_dias) %>%
#   filter(hosp_stay_bin == "1",
#          DESC_TIPO_ALTA == "Defunción") %>%
  # select(ingreso = COD_FEC_INGRESO, alta = COD_FEC_ALTA, dias_hosp = estancia_hospitalaria_dias,infect_covid_first_date, infeccion_ingreso_dias, hosp_stay_bin, infeccion_alta_dias, DESC_TIPO_ALTA)

# we are just going to take into account first hospitalization
#filtramos los 5 códigos principales sólo por ICD relacionados con COVID, según conteo
# we are only selecting fist admission per patient
episodios_cmbd_first <- episodios_cmbd %>%
  filter(hosp_stay_bin == 1) %>%
  filter(
    COD_D1 %in% icd_ofinterest | COD_D2 %in% icd_ofinterest | COD_D3 %in% icd_ofinterest | COD_D4 %in% icd_ofinterest | COD_D5 %in% icd_ofinterest
  ) %>%
  group_by(NUHSA_ENCRIPTADO) %>%
  filter(row_number() == 1) %>%
  select(
    NUHSA_ENCRIPTADO,
    COD_FEC_INGRESO,
    COD_FEC_ALTA,
    estancia_hospitalaria_dias,
    hosp_stay_bin,
    icu_stay_bin,
    infeccion_ingreso_dias
  )

remove(episodios_cmbd)
remove(result)
```

## vacunas

Jaime M

TODO address non european shots: grepl('COVID-19 Sinopharm|COVID-19 Sputnik V|COVID-19 Covishield|COVID-19 CoronaVac (Sinovac Biotech)|COVID-19 CanSinoBIO|COVID-19 Covaxin|COVID-19 HIPRA')

Criterios de exclusión: pacientes de 5 dosis.

-	Vacunas de la gripe de las campañas 2020-21 y 2021-2022.
-	Vacunas de neumococo en cualquier momento hasta el 31/03/2022.
-	Todas las vacunas relacionadas con el COVID 19 hasta el 31/03/2022.

TODO STAGI: *Pedir campañas 2019-20.* 

TODO hay varias vacunas de neumo y gripe por paciente.
TODO estudiar numero de infecciones
```{r}
vacunas_t <- vroom("/opt/datos_compartidos/vacunas_data/total/ENC_VACUNAS_VACUNAS_TODO.txt") %>%
  lazy_dt() %>%
  as.data.frame() %>% 
  left_join(.,infect_covid4,by = "NUHSA_ENCRIPTADO") %>% 
  mutate(
    FEC_VACUNACION = ymd(FEC_VACUNACION), # dates need to be converted from the original source, missing means NO
    vac_infecc_umbral = trunc((FEC_VACUNACION %--% infect_covid_first_date) / days(1)) # dias entre vacunacion e infeccion
  )

#convertir los nombres de las vacunas en factores para disminuir coste de computación

vacunas_t <- vacunas_t %>% 
  mutate(NOM_VACUNA = as.factor(NOM_VACUNA))

# Y FILTRAR LAS VACUNAS QUE DESEAMOS
vacunas_t <- vacunas_t %>% 
  filter(NOM_VACUNA == "COVID-19 AstraZeneca"|
           NOM_VACUNA == "COVID-19 Janssen"|
           NOM_VACUNA == "COVID-19 Pfizer/BioNTech"|
           NOM_VACUNA == "COVID-19 Moderna"|
           NOM_VACUNA == "COVID-19 Novavax")
vacunas_t$NOM_VACUNA <- droplevels(vacunas_t$NOM_VACUNA)
         
# what shot was first per patient?
vacunas_t_covid_first <- vacunas_t %>%
  filter(vac_infecc_umbral >= 14) %>% # los dias entre la vacunacion e infeccion han de ser >= 14
  group_by(NUHSA_ENCRIPTADO) %>%
  arrange(FEC_VACUNACION) %>% 
  filter(row_number() == 1) %>% 
  transmute(
    NUHSA_ENCRIPTADO,
    covid_first_name = NOM_VACUNA,
    covid_first_date = FEC_VACUNACION
  )

# TODO cómo afecta el umbral de 14 días a la pauta completa?
# full shots
vacunas_t_covid_full <- vacunas_t %>%
  filter(vac_infecc_umbral >= 14) %>% # los dias entre la vacunacion e infeccion han de ser >= 14
  # ALVARO SERRANO: la linea anterior la introduzco el dia 22/02/2023. Al no estar en el codigo previamente, -->
  # estabamos considerando para cada paciente la ultima dosis puesta a fecha de extraccion de datos (mayo 2022 -->
  # si no recuerdo mal) y no hasta catorce dias antes de la infeccion, por lo que los analisis -->
  # incluyen datos erroneos e incurren en sesgos. Vamos, que no vale decir que con tres dosis te proteges -->
  # mas, basandose en estos datos. Seguramente sea asi, pero los resultados hechos con el codigo anterior -->
  # no deben fundamentar dicha afirmacion.
  group_by(NUHSA_ENCRIPTADO) %>%
  arrange(FEC_VACUNACION) %>% 
  filter(row_number()==3) %>% 
  transmute(
    NUHSA_ENCRIPTADO,
    covid_full_name = NOM_VACUNA,
    covid_full_date = FEC_VACUNACION
  )

# number of shots
vacunas_t_covid_pautas <- vacunas_t %>% 
  filter(vac_infecc_umbral >= 14) %>%
  # ALVARO SERRANO: idem a lo escrito en el pipeline anterior.
  group_by(NUHSA_ENCRIPTADO) %>%
  summarise(pautas_covid = n())

remove(vacunas_t)
```

# Joining across datasets

```{r}
print(Sys.time())
estudio_vacunas_t_final <- Reduce(function(...) merge(..., all.x=TRUE), list(
  infect_covid4
  , poblacion_diana 
  , pupa_opt
  , infect_COVID_num  
  , episodios_cmbd_first 
  , vacunas_t_covid_first
  , vacunas_t_covid_full
  , vacunas_t_covid_pautas
))
print(Sys.time())
```

# Selecting only required columns

```{r}
cols_to_exclude <- c("NUHSA_ENCRIPTADO", "COD_FEC_NACIMIENTO")
cols_to_include <- setdiff(names(estudio_vacunas_t_final), cols_to_exclude)
estudio_vacunas_t_final_selected <- estudio_vacunas_t_final %>% select(cols_to_include)
```

# New variables creation / adjustment

```{r}
estudio_vacunas_t_final_selected %<>%
  # Clean the column names using clean_names()
  clean_names() %>% 
  # Modify certain columns using mutate()
  mutate(
    # Set the infect_covid_first_date column to have a length of either 8 or 10 characters
    infect_covid_first_date = case_when(
      stri_length(as.character(infect_covid_first_date)) %in% c(8, 10) ~ infect_covid_first_date
    ),
    # Convert the hosp_stay_bin column to numeric
    hosp_stay_bin = as.numeric(hosp_stay_bin),
    # Convert the infeccion_ingreso_dias column to numeric
    infeccion_ingreso_dias = as.numeric(infeccion_ingreso_dias)
)


estudio_vacunas_t_final_selected %<>%
  mutate(  
    # Set the mortality30d column to 1 if the difference between fec_fallecimiento and infect_covid_first_date is less than 31 days, 0 otherwise
    mortality30d = case_when(
      (ymd(fec_fallecimiento) - infect_covid_first_date) < 31 ~ 1,
      T ~ 0
    ),
    # Set the estancia_hospitalaria_dias column to NA if hosp_stay_bin is not equal to 1, otherwise convert it to an integer
    estancia_hospitalaria_dias = case_when(
      hosp_stay_bin == 1 ~ as.integer(estancia_hospitalaria_dias),
      T ~ NA_integer_
    ),
    # Convert covid_first_name to character, replace NAs with "No vacunado", and convert to factor
    covid_first_name = as.character(covid_first_name),
    covid_first_name = if_else(is.na(covid_first_name), "No vac", covid_first_name),
    covid_first_name = factor(covid_first_name),
    # Convert covid_full_name to character, replace NAs with "No vacunado o vacunado con menos de tres dosis", and convert to factor
    covid_full_name = as.character(covid_full_name),
    covid_full_name = if_else(is.na(covid_full_name), "No vac or <3 shots", covid_full_name),
    covid_full_name = factor(covid_full_name),
    # Convert pautas_covid to an ordered factor
    pautas_covid = as.character(pautas_covid),
    pautas_covid = if_else(is.na(pautas_covid), "0", pautas_covid),
    pautas_covid = as.factor(pautas_covid)
  ) %>% 
  suppressWarnings()     

# grouping cancers by type
estudio_vacunas_t_final_selected %<>%
  mutate(cancer_organo_solido = 
    cancer_de_bronquio_y_pulmon | 
      cancer_de_cabeza_y_cuello |
      cancer_de_estomago |
      cancer_de_hueso_y_tejidos_blandos |
      cancer_de_mama |
      cancer_de_ovario |
      cancer_de_pancreas |
      cancer_de_prostata |
      cancer_de_rinon_y_pelvis_renal |
      cancer_de_testiculo |
      cancer_de_tiroides |
      cancer_de_utero |
      cancer_de_vejiga |
      cancer_de_cuello_uterino |
      melanoma_de_piel |
      sarcoma_de_kaposi,
    
    cancer_hematologico = 
      cancer_inmunoproliferativo |
        enfermedad_de_hodgkin |
        leucemia |
        linfoma_no_hodgkin
)

estudio_vacunas_t_final_selected %<>% 
  mutate(age_num = as.numeric(age),
         estancia_hospitalaria_dias = as.numeric(estancia_hospitalaria_dias),
         age_num_decada = age_num/10,
         cancer_organo_solido = as.numeric(cancer_organo_solido),
         cancer_organo_solido = if_else(is.na(cancer_organo_solido), 0, cancer_organo_solido),
         cancer_hematologico = as.numeric(cancer_hematologico),
         cancer_hematologico = if_else(is.na(cancer_hematologico), 0, cancer_hematologico),
         icu_stay_bin = as.numeric(as.character(icu_stay_bin))
         )

# we want the factors in no particular order
estudio_vacunas_t_final_selected <- estudio_vacunas_t_final_selected %>% 
  mutate_at(c("desc_sexo", "pautas_covid"), droplevels)
```

# Adressing missingness

## Mapping initial missingness

```{r}
# Count the number of missing values in each column of the data frame 
miss_count <- colSums(is.na(estudio_vacunas_t_final_selected))

# Calculate the percentage of missing values in each column
miss_percent <- round(miss_count / nrow(estudio_vacunas_t_final_selected) * 100,2)

# Order the results by the column names in the original data frame
ordered_miss_percent <- miss_percent[order(names(estudio_vacunas_t_final_selected))]

# Save the results in a new data frame
miss_percent_df <- data.frame(Column = names(ordered_miss_percent), Missing_Percent = ordered_miss_percent)
```

### Columns NA filling

```{r}
quien_tiene_na <- map_dfc(estudio_vacunas_t_final_selected, ~sum(is.na(.)))


fill_cols_to_exclude <- 
  estudio_vacunas_t_final_selected %>% 
  # ALVARO: hago lo siguiente para ahorrar tiempo, escribiendo asma:vih
  select(
    infect_covid_first_date, cod_sexo, desc_sexo, cod_municipio, desc_municipio,
    fec_fallecimiento, age, mortality, cod_fec_ingreso, cod_fec_alta,
    infeccion_ingreso_dias, covid_first_name, covid_first_date,
    covid_full_name, covid_full_date, pautas_covid, mortality30d,
    cancer_organo_solido, cancer_hematologico, age_num, age_num_decada
  ) %>% 
  colnames()
fill_cols_to_include <- setdiff(names(estudio_vacunas_t_final_selected), fill_cols_to_exclude)


# ALVARO: codigo "de seguridad" para vigilar que el lapply no la lie parda
summary_antes_lapply <- 
  estudio_vacunas_t_final_selected %>% 
  select(fill_cols_to_include) %>% 
  mutate(
    hosp_stay_bin = as.factor(hosp_stay_bin),
    icu_stay_bin = as.factor(icu_stay_bin)
  ) %>% 
  summary()
summary_antes_lapply


estudio_vacunas_t_final_selected[, fill_cols_to_include] <- 
  lapply(
    estudio_vacunas_t_final_selected[, fill_cols_to_include], 
    function(x) ifelse(is.na(x), 0, x)
  )


# ALVARO: codigo "de seguridad" para vigilar que el lapply no la lie parda
summary_despues_lapply <- 
  estudio_vacunas_t_final_selected %>% 
  select(fill_cols_to_include) %>% 
  mutate(
    hosp_stay_bin = as.factor(hosp_stay_bin),
    icu_stay_bin = as.factor(icu_stay_bin)
  ) %>% 
  summary()
summary_despues_lapply
```

### Mapping final missingness

```{r}
# Count the number of missing values in each column of the data frame 
miss_count <- colSums(is.na(estudio_vacunas_t_final_selected))

# Calculate the percentage of missing values in each column
miss_percent <- round(miss_count / nrow(estudio_vacunas_t_final_selected) * 100,2)

# Order the results by the column names in the original data frame
ordered_miss_percent <- miss_percent[order(names(estudio_vacunas_t_final_selected))]

# Save the results in a new data frame
miss_percent_df <- data.frame(Column = names(ordered_miss_percent), Missing_Percent = ordered_miss_percent)
```

# Exclusion criteria

No exclusion criteria by now.

```{r}
print('Número pacientes con infección COVID confirmada por PCR y fecha de infección disponible')
a<-nrow(estudio_vacunas_t_final_selected)
a

print('Pacientes excluídos con Sexo No Especificado')
estudio_vacunas_t_final_selected<-estudio_vacunas_t_final_selected %>% filter (desc_sexo %in% c('Hombre','Mujer') )
b<-nrow(estudio_vacunas_t_final_selected)
a-b

print('Pacientes excluídos con más de 4 dosis')
estudio_vacunas_t_final_selected<-estudio_vacunas_t_final_selected %>% filter (pautas_covid %in% c('0','1','2','3','4'))
c<-nrow(estudio_vacunas_t_final_selected)
b-c

print('Pacientes excluídos sin información de edad')
estudio_vacunas_t_final_selected%<>%filter(!is.na(age))
d<-nrow(estudio_vacunas_t_final_selected)
c-d
  
print('Número final de pacientes')
nrow(estudio_vacunas_t_final_selected)

estudio_vacunas_t_final_selected <- 
  estudio_vacunas_t_final_selected %>% 
  filter((covid_first_date > ymd(20201226)) | is.na(covid_first_date))
e <- nrow(estudio_vacunas_t_final_selected)
d-e

estudio_vacunas_t_final_selected <- 
  estudio_vacunas_t_final_selected %>% 
  filter(infect_covid_first_date > ymd(20200229))
f <- nrow(estudio_vacunas_t_final_selected)
e-f
```

# Saving Rds and Env

```{r}
saveRDS(estudio_vacunas_t_final_selected, file = "/opt/datos_compartidos/vacunas_data/Rfiles/estudio_vacunas_t_final_selected.rds")

# save.image(file='/opt/datos_compartidos/vacunas_data/Rfiles/vac_environment.RData')
```

